# QML и Python изменения относительно baseline 3b8da9a

## 1. Перестройка QML/QtQuick
- **Главный загрузчик сцены** теперь представляет собой `main.qml`, который переключает `Loader` между новым `SimulationRoot` и упрощённым `SimulationFallbackRoot` в зависимости от наличия `SceneBridge` из Python. Это заменяет прежний прямой `UFrameScene.qml` и вводит fallback, где отсутствует полноценная 3D-сцена.【F:assets/qml/main.qml†L1-L40】【F:assets/qml/SimulationFallbackRoot.qml†L1-L120】
- **Модульная структура QML**: создан пакет `PneumoStabSim` с корневым `SimulationRoot.qml`, который импортирует выделенные подкаталоги (`camera`, `components`, `effects`, `geometry`, `lighting`, `scene`). Это обеспечивает централизованное управление состоянием сцены, геометрией и освещением и заменяет монолитную сцену из baseline.【F:assets/qml/PneumoStabSim/SimulationRoot.qml†L1-L115】【F:assets/qml/geometry/SuspensionCorner.qml†L1-L120】
- **Новые UI-компоненты**: добавлены элементы управления профилями (`ProfileManagerControls.qml`) и трассировкой сигналов (`SignalTracePanel.qml`), а также датчики для IBL (`IblProbeLoader.qml`) и HUD камеры. Эти компоненты расширяют функциональность графического слоя по сравнению с baseline, где подобные панели отсутствовали.【F:assets/qml/components/ProfileManagerControls.qml†L1-L120】【F:assets/qml/components/SignalTracePanel.qml†L1-L120】
- **Расширенная сцена**: `SimulationRoot` создаёт `View3D` с общими материалами, контроллерами света и четырьмя экземплярами `SuspensionCorner`, конструируя анимированную схему из отдельных модулей вместо жёстко закодированной сцены.【F:assets/qml/PneumoStabSim/SimulationRoot.qml†L212-L360】

## 2. Изменения Python-логики (src/core, src/ui)
- **Сервисные слои**: введены новые модули `SettingsService`, `SettingsManager` и контейнер зависимостей. Они обеспечивают ленивую загрузку JSON-конфигураций, валидацию по схеме и DI для тестов, чего не было в baseline.【F:src/core/settings_service.py†L1-L120】【F:src/core/settings_manager.py†L1-L120】【F:src/core/container.py†L1-L120】
- **QML-мост**: вместо прямых вызовов теперь используется модуль `src/ui/qml_bridge.py` с декларативными метаданными и ленивой регистрацией сигналов. MainWindow подключается через слой-адаптер `src/ui/main_window_pkg/qml_bridge.py` и регистрирует типы через `qml_registration.py`, добавляя объект `SceneBridge` для потоковых обновлений в QML.【F:src/ui/qml_bridge.py†L1-L120】【F:src/ui/main_window_pkg/qml_bridge.py†L1-L40】【F:src/ui/qml_registration.py†L1-L120】
- **Главное окно** переработано в пакет `main_window_pkg`. Класс `MainWindow` действует как координатор, делегирующий UI, мост, сигнализацию и синхронизацию отдельным модулям. Контекст QML заполняется начальными данными и `SceneBridge`, что меняет контракт с QML по сравнению с baseline-монолитом.【F:src/ui/main_window_pkg/main_window_refactored.py†L1-L160】【F:src/ui/main_window_pkg/ui_setup.py†L160-L280】
- **Панели UI** разбиты на модули (`src/ui/panels/geometry`, `graphics`, `pneumo`, `modes`). Каждый coordinator собирает состояние через `collect_state`, отключает автосохранение и направляет события наружу, что меняет взаимодействие Python↔QML и настройки.【F:src/ui/panels/graphics/panel_graphics_refactored.py†L1-L160】【F:src/ui/panels/geometry/panel_geometry_refactored.py†L1-L120】【F:src/ui/panels/pneumo/panel_pneumo_refactored.py†L1-L160】

## 3. Влияние на анимированную схему
- **Новый цикл обновления**: `SimulationRoot` хранит данные об углах, позициях поршней и масштабировании в свойствах и применяет батч-обновления из Python через `SceneBridge`. Функции `applyBatchedUpdates`, `leverAngleFor`, `pistonPosition` и т.д. перерабатывают схему под новый API.【F:assets/qml/PneumoStabSim/SimulationRoot.qml†L96-L120】【F:assets/qml/PneumoStabSim/SimulationRoot.qml†L680-L760】
- **Модульные углы и цилиндры**: `SuspensionCorner` рассчитывает позиции шарниров, цилиндров и поршня на основе входных параметров и окрашивает их в зависимости от ошибок длины, заменяя предыдущее жёсткое определение в `UFrameScene`. Это меняет визуализацию и диагностику схемы.【F:assets/qml/geometry/SuspensionCorner.qml†L1-L160】【F:assets/qml/geometry/SuspensionCorner.qml†L160-L240】
- **Связь Python→QML**: `SceneBridge` в Python агрегирует категории обновлений (geometry, lighting, animation и т.д.) и ретранслирует их в QML, обеспечивая обратную совместимость с батчами. Это новый путь синхронизации для анимации.【F:src/ui/scene_bridge.py†L1-L120】【F:src/ui/scene_bridge.py†L120-L200】

## 4. Изменения в UI-элементах
- **Контекстное заполнение QML** теперь включает профили настроек, событийный автобус и сервис трассировки сигналов, что влияет на панели и HUD в QML.【F:src/ui/main_window_pkg/ui_setup.py†L200-L280】
- **Графическая панель** исключила автосохранение, добавила централизованный `GraphicsSettingsService` и новые вкладки/кнопки («Экспорт анализа» и т.д.), влияющие на управление эффектами и освещением.【F:src/ui/panels/graphics/panel_graphics_refactored.py†L40-L160】【F:src/ui/panels/graphics/panel_graphics_settings_manager.py†L1-L120】
- **Пневматическая панель** получила модульный `PneumoStateManager`, вкладки «Термо/Давление/Клапаны/Ресивер» и новые сигналы (`receiver_volume_changed`), что меняет поведение кнопок и биндингов.【F:src/ui/panels/pneumo/panel_pneumo_refactored.py†L1-L160】
- **Добавлены QML-компоненты** для управления профилями и трассировки, которые ожидают сервисы из Python (`settingsProfiles`, `signalTrace`), что требует соответствующих биндингов на Python-стороне.【F:assets/qml/components/ProfileManagerControls.qml†L1-L120】【F:assets/qml/components/SignalTracePanel.qml†L1-L120】

## 5. Выявленные регрессии и удалённые блоки
- **Отсутствие `UFrameScene.qml`**: `SuspensionSceneHost` по-прежнему ищет legacy-файл и при его отсутствии загружает `SimulationFallbackRoot`, который лишь логирует данные и не рисует 3D-сцену. Это фактически отключает рабочую визуализацию, если новый `SimulationRoot` не используется в `QQuickWidget` напрямую.【F:src/ui/qml_host.py†L90-L150】【F:assets/qml/SimulationFallbackRoot.qml†L1-L120】
- **Зависимость от новых сервисов**: модульные панели и `MainWindow` теперь требуют `SettingsService`/`GraphicsSettingsService`. При отсутствии или несогласованности JSON (например, старых ключей материалов) загрузка завершится ошибкой, что требует адаптации старых конфигураций.【F:src/ui/panels/graphics/panel_graphics_settings_manager.py†L1-L120】【F:src/core/settings_service.py†L78-L120】
- **Незадействованные резервные сцены**: файл `main_working_builtin.qml` и другие альтернативы остались неизменёнными, но не интегрированы с новым `SceneBridge`, поэтому при переключении на них теряется батч-синхронизация и события Python. Требуется адаптация, чтобы они принимали `pythonSceneBridge` аналогично `main.qml`.【F:assets/qml/main_working_builtin.qml†L1-L80】
- **Отсутствие контроллеров в fallback**: `SimulationFallbackRoot` не реализует реальные модели или камеры — только хранит последние payload'ы. Если fallback активируется (например, при ошибке загрузки модульной сцены), пользователи теряют визуальную обратную связь и анимацию, что требует доработки или возврата полноценного 2D/3D режима в fallback.【F:assets/qml/SimulationFallbackRoot.qml†L1-L120】

