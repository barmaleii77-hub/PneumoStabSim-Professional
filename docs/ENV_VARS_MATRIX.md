# Матрица переменных окружения (Environment Variables Matrix)

Этот документ фиксирует критичные и рекомендуемые переменные окружения,
используемые PneumoStabSim Professional для запуска, тестирования и headless
прогонов. Обновляйте его при добавлении новых ключей.

> Источник правды: `tools/env_registry.py` — все критичные переменные и
> подсказки (suggested defaults) централизованы и валидируются перед запуском
> приложения (`app.py`) и при трассировке (`tools/trace_launch.py`). Не
> дублируйте списки в коде — расширяйте реестр.

## Критичные переменные

| Name | Назначение | Тип | Рекомендуемое значение (по умолчанию) | Применение |
| ---- | ---------- | --- | ------------------------------------ | ---------- |
| QT_QPA_PLATFORM | Qt платформа (headless / GUI) | core | offscreen (Linux headless) | Запуск Qt без окна или выбор плагина |
| QT_PLUGIN_PATH | Путь к Qt плагинам | core | (устанавливается скриптами) | Импорт платформенных плагинов |
| QML2_IMPORT_PATH | Пути импорта QML модулей | core | (устанавливается скриптами) | Загрузка QML компонентов |
| QT_QUICK_CONTROLS_STYLE | Единый стиль контролов | cosmetic | Basic | Стабильность внешнего вида в тестах |
| QSG_RHI_BACKEND | Графический backend RHI | perf | d3d11 (Windows), opengl (Linux) | Режим рендеринга Qt Quick 3D |
| LIBGL_ALWAYS_SOFTWARE | Принудительный софтверный OpenGL | stability | 1 (Linux headless) | Предсказуемость в контейнерах |
| PSS_HEADLESS | Флаг headless режима тестов | mode | 1 (в CI) | Тесты без GUI |
| PSS_LOG_PRESET | Профиль логирования | diagnostics | normal / debug / trace | Включение расширенных каналов логов |

## Дополнительные служебные переменные

| Name | Назначение | Примечание |
| ---- | ---------- | ---------- |
| PYTEST_DISABLE_PLUGIN_AUTOLOAD | Управление автоподгрузкой плагинов pytest | Устанавливается в ci_tasks для детерминизма |
| CI_TASKS_ENABLE_COVERAGE | Включение coverage | По умолчанию включено |
| COVERAGE_MIN_PERCENT | Минимально допустимый процент покрытия | Quality gate (см. AGENTS.MD) |
| PSS_ALLOW_SKIPPED_TESTS | Разрешить временно пропущенные тесты | Требует CI_SKIP_REASON |
| CI_SKIP_REASON | Объяснение почему пропуски допущены | Протокол прозрачности CI |
| CI_TASKS_SKIP_SHADERS | Пропуск валидации шейдеров | Для сред без qsb |
| CI_FAIL_ON_SHADER_WARNINGS | Строгий режим шейдерных предупреждений | Поднимает ошибку при warnings |
| QML_LINTER | Явный путь к qmllint | Используется если автодетект не сработал |
| QML_LINT_PATHS | Явный список целей QML lint | При отсутствии используется автогенерация |

## Валидация и статусы

Реестр возвращает отчёт со списками `missing`, `empty` и матрицей. Статус
каждой переменной:

- `ok` — присутствует и непустая
- `missing` — отсутствует в окружении (будет предупреждение)
- `empty` — определена, но пустая строка (будет предупреждение)

Markdown-таблица формируется вызовом:

```python
from tools.env_registry import validate_environment, format_matrix_markdown
report = validate_environment(os.environ)
print(format_matrix_markdown(report))
```

## Политика обновления
- Добавьте переменную сначала в реестр `tools/env_registry.py`, затем обновите этот файл.
- Сохраняйте русские описания, технические термины допускаются на английском.
- Не дублируйте значения между README.md и этим документом — README даёт сценарии, матрица фиксирует факты.

## История изменений
- v1 (инициализация): базовый набор критичных переменных.
- v2: добавлена централизованная ссылка на реестр и секция статусов.
