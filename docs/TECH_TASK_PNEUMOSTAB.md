# Техническое задание на разработку PneumoStabSim Codex

## 1. Назначение документа

Настоящее техническое задание описывает архитектуру, физические модели и алгоритмы цифрового двойника пневмостабилизатора, реализованного в PneumoStabSim. Документ предназначен для постановки задачи системе Codex и содержит полный набор терминов, обозначений, таблиц параметров, ограничений и допущений, необходимых для последующей разработки и тестирования.

## 2. Термины и обозначения

| Обозначение | Описание | Источник |
|-------------|----------|----------|
| LP, PP, LZ, PZ | Колёса: левое переднее, правое переднее, левое заднее, правое заднее | `Wheel` enum【F:src/pneumo/enums.py†L1-L15】 |
| HEAD / ROD | Камеры цилиндра: надштоковая (HEAD) и штоковая (ROD) | `Port` enum【F:src/pneumo/enums.py†L18-L31】 |
| A1, B1, A2, B2 | Диагональные пневмолинии | `Line` enum【F:src/pneumo/enums.py†L34-L47】 |
| ThermoMode | Режим термопроцесса: адиабатический или изотермический | `ThermoMode` enum【F:src/pneumo/enums.py†L50-L61】 |
| ReceiverVolumeMode | Режим перерасчёта ресивера при изменении объёма | `ReceiverVolumeMode` enum【F:src/pneumo/enums.py†L64-L77】 |
| CheckValveKind | Тип обратного клапана (из атмосферы в линию или в ресивер) | `CheckValveKind` enum【F:src/pneumo/enums.py†L80-L93】 |
| ReliefValveKind | Тип предохранительного клапана (минимальное давление, жёсткость, аварийный) | `ReliefValveKind` enum【F:src/pneumo/enums.py†L96-L111】 |
| R<sub>air</sub>, γ | Газовая постоянная и показатель адиабаты воздуха | Константы единиц【F:src/common/units.py†L8-L32】 |
| T<sub>amb</sub>, P<sub>amb</sub> | Температура и давление окружающей среды | Константы единиц【F:src/common/units.py†L24-L32】 |
| V<sub>head</sub>, V<sub>rod</sub> | Объёмы камер цилиндра | Методы `CylinderState.vol_head/vol_rod`【F:src/pneumo/cylinder.py†L19-L73】 |
| m, p, T | Масса, давление, температура рабочего газа | `LineGasState`, `TankGasState`【F:src/pneumo/gas_state.py†L13-L107】 |

## 3. Компоновка пневмостабилизатора

### 3.1 Структурные элементы

| Элемент | Роль | Основные параметры | Источник |
|---------|------|--------------------|----------|
| Цилиндры (`CylinderState`) | Преобразование перемещений рычагов в изменение объёмов камер | Геометрия `CylinderGeom`, принадлежность оси (перед/зад), положение поршня `x` | 【F:src/pneumo/cylinder.py†L1-L104】 |
| Геометрия цилиндра (`CylinderGeom`) | Хранение диаметра, хода, мёртвых зон, остаточных объёмов | Ограничения на диаметры, ход, минимальные объёмы, проекция на ось цилиндра | 【F:src/pneumo/geometry.py†L1-L210】 |
| Геометрия рычага (`LeverGeom`) | Преобразование угла в положение шарнира штока | Длина рычага, положение точки крепления штока, расстояние до рамы | 【F:src/pneumo/geometry.py†L24-L86】 |
| Пневмолиния (`PneumoLine`) | Соединение пар камер по диагональной схеме, интерфейс с клапанами | Два конца (колесо+порт), клапаны к атмосфере и ресиверу, текущее давление | 【F:src/pneumo/line.py†L1-L94】 |
| Ресивер (`ReceiverState`) | Аккумулятор давления с режимами пересчёта при изменении объёма | Диапазон объёмов, давление, температура, режим перерасчёта | 【F:src/pneumo/receiver.py†L1-L94】 |
| Обратные клапаны (`CheckValve`) | Ограничение направления потока между линией и внешними узлами | Минимальный перепад открытия, эквивалентный диаметр, гистерезис | 【F:src/pneumo/valves.py†L1-L170】 |
| Предохранительные клапаны (`ReliefValve`) | Сброс давления из ресивера по заданным порогам | Уставка, гистерезис, наличие/отсутствие дросселирования | 【F:src/pneumo/valves.py†L170-L312】 |
| Газовая сеть (`GasNetwork`) | Расчёт потоков, обновление масс и давлений в линиях и ресивере | Карты `LineGasState`, `TankGasState`, ссылки на пневмосистему | 【F:src/pneumo/network.py†L1-L209】 |
| Пневмосистема (`PneumaticSystem`) | Проверка диагональных соединений, обновление геометрии по углам рычагов | Списки цилиндров, линий, ресивер, главный отсечной клапан | 【F:src/pneumo/system.py†L1-L205】 |

### 3.2 Диагональная схема соединений

- A1: LP ROD ↔ PZ HEAD
- B1: LP HEAD ↔ PZ ROD
- A2: PP ROD ↔ LZ HEAD
- B2: PP HEAD ↔ LZ ROD

Нарушение схемы приводит к ошибке конфигурации при инициализации `PneumaticSystem`【F:src/pneumo/system.py†L24-L89】.

## 4. Геометрическая модель

1. Поршень позиционируется в пределах ±L<sub>travel_max</sub>/2, где L<sub>travel_max</sub> вычисляется из длины внутренней полости и мёртвых зон【F:src/pneumo/cylinder.py†L29-L47】【F:src/pneumo/geometry.py†L164-L217】.
2. Объёмы камер определяются произведением эффективной площади и расстояния до поршня с учётом остаточных объёмов【F:src/pneumo/cylinder.py†L48-L89】.
3. Позиция поршня пересчитывается по геометрии рычага и точке крепления штока, включая ортогональную проекцию на ось цилиндра【F:src/pneumo/cylinder.py†L90-L125】.
4. Геометрия валидируется на разумные диапазоны размеров, соответствие минимальным остаточным объёмам и допустимость диаметра штока【F:src/pneumo/geometry.py†L87-L210】.

## 5. Термо- и газодинамическая модель

### 5.1 Состояния газа

- Линия (`LineGasState`) хранит массу, температуру, давление и текущий/предыдущий объёмы; при изменении объёма давление пересчитывается по закону идеального газа【F:src/pneumo/gas_state.py†L13-L65】.
- Ресивер (`TankGasState`) поддерживает режимы перерасчёта при скачке объёма: без пересчёта или адиабатический с изменением температуры и давления【F:src/pneumo/gas_state.py†L68-L146】.
- Совмещённое состояние (`GasState`) обеспечивает суммарные величины и синхронные обновления линий и ресивера【F:src/pneumo/gas_state.py†L99-L137】.

### 5.2 Термические режимы

- Изотермическое обновление: T = const, p пересчитывается из p = m·R·T / V (`iso_update`)【F:src/pneumo/gas_state.py†L173-L191】.
- Адиабатическое обновление: T и p изменяются пропорционально (V<sub>0</sub>/V)<sup>γ−1</sup> и (V<sub>0</sub>/V)<sup>γ</sup> соответственно (`adiabatic_update`)【F:src/pneumo/gas_state.py†L193-L213】.
- Скачок объёма ресивера: при режиме `ADIABATIC_RECALC` применяется пересчёт температуры и давления по адиабатическим соотношениям【F:src/pneumo/gas_state.py†L215-L245】.

### 5.3 Расчёт масс и давлений

- Функции `p_from_mTV` и `gas_mass_from_pVT` реализуют прямое и обратное применение закона идеального газа с проверкой знаков входных величин【F:src/pneumo/gas_state.py†L215-L246】.
- Дополнительные утилиты `adiabatic_*`, `isothermal_p`, `gas_mass_from_pVT` предоставлены в `thermo.py` для аналитических расчётов и тестирования【F:src/pneumo/thermo.py†L1-L93】.

## 6. Моделирование потоков

### 6.1 Базовые формулы

| Функция | Назначение | Формула / критерий | Источник |
|---------|------------|---------------------|----------|
| `rho(p, T)` | Плотность газа | ρ = p / (R<sub>air</sub>·T) | 【F:src/pneumo/flow.py†L1-L23】 |
| `area(d_eq)` | Эквивалентная площадь отверстия | A = π·(d<sub>eq</sub>/2)² | 【F:src/pneumo/flow.py†L25-L38】 |
| `is_choked_flow` | Проверка звукового течения | p<sub>down</sub>/p<sub>up</sub> ≤ (2/(γ+1))^{γ/(γ−1)} | 【F:src/pneumo/flow.py†L40-L63】 |
| `mass_flow_incompressible` | Дроссель с малой сжимаемостью | √m(2Δp/ρ) * C<sub>d</sub>·A | 【F:src/pneumo/flow.py†L65-L97】 |
| `mass_flow_choked` | Звуковой расход | C<sub>d</sub>·A·p<sub>up</sub>·√(γ/(R·T<sub>up</sub>))·(2/(γ+1))^{(γ+1)/(2(γ−1))} | 【F:src/pneumo/flow.py†L99-L134】 |
| `mass_flow_subsonic` | Сжимаемый дозвуковой поток | Формула из изоэнтропических соотношений, учитывает отношение давлений | 【F:src/pneumo/flow.py†L136-L184】 |
| `mass_flow_orifice` | Выбор режима течения | Автоматический выбор между `mass_flow_choked`, `mass_flow_subsonic`, `mass_flow_incompressible` | 【F:src/pneumo/flow.py†L186-L236】 |
| `mass_flow_unlimited` | Аварийный сброс | Использует большое d<sub>eq</sub> и `mass_flow_orifice` | 【F:src/pneumo/flow.py†L238-L258】 |

### 6.2 Алгоритм клапанов

1. Проверка направления и перепада давления для обратных клапанов с учётом гистерезиса (`CheckValve.is_open`)【F:src/pneumo/valves.py†L53-L160】.
2. Определение порогов открытия/закрытия для предохранительных клапанов, включая особый режим `SAFETY` без дросселирования (`ReliefValve.is_open`)【F:src/pneumo/valves.py†L200-L272】.
3. Расчёт расхода через предохранительный клапан с учётом коэффициента дросселирования и перепада давления (`ReliefValve.calculate_flow`)【F:src/pneumo/valves.py†L274-L312】.

## 7. Алгоритм симуляции

### 7.1 Сетевой цикл (`GasNetwork.apply_valves_and_flows`)

1. Расчёт объёмов линий на основе текущих положений цилиндров (`compute_line_volumes`)【F:src/pneumo/network.py†L28-L78】.
2. Пересчёт давлений в соответствии с выбранным терморежимом (`update_pressures_due_to_volume`)【F:src/pneumo/network.py†L80-L106】.
3. Для каждой линии:
   - При открытом атмосферном клапане добавляется масса и пересчитывается температура по массам (`_add_mass_to_line`)【F:src/pneumo/network.py†L108-L174】.
   - При открытом клапане в ресивер вычисляется расход и переносится доступная масса в ресивер с энергобалансом (`_transfer_mass_line_to_tank`)【F:src/pneumo/network.py†L176-L226】.
4. Обработка предохранительных клапанов ресивера, включая аварийный сброс `mass_flow_unlimited`, и коррекция массы/давления в ресивере【F:src/pneumo/network.py†L228-L310】.
5. При открытом главном отсечном клапане выравниваются давления и массы во всех линиях пропорционально объёмам (`enforce_master_isolation`)【F:src/pneumo/network.py†L312-L362】.
6. Проверка инвариантов возвращает список ошибок/предупреждений, фиксируя отрицательные массы, температуры и разбалансировку при открытой изоляции【F:src/pneumo/network.py†L364-L414】.

### 7.2 Шаг интеграции (`advance_gas`)

1. Логирование шага и терморежима.
2. Обновление давлений из-за кинематических изменений (см. п.7.1-2).
3. Применение клапанов и потоков (см. п.7.1-3,4).
4. Принудительное выравнивание при открытой изоляции (см. п.7.1-5).
5. Итоговое логирование состояния линий и ресивера【F:src/pneumo/sim_time.py†L1-L76】.

### 7.3 Запуск серии шагов (`run_gas_simulation`)

- Выполняется цикл до `total_time` с шагом `dt`, сохраняется история давлений и масс, опционально ведётся периодическое логирование【F:src/pneumo/sim_time.py†L78-L159】.
- По завершении проверяются инварианты газовой сети, результаты логируются【F:src/pneumo/sim_time.py†L160-L175】.

## 8. Валидация и диагностика

| Контрольный уровень | Проверка | Реализация |
|---------------------|----------|------------|
| Геометрия | Диаметры, ход, остаточные объёмы, положения рычагов | `CylinderGeom.validate_invariants`, `LeverGeom.validate_invariants`, `CylinderState.validate_invariants`【F:src/pneumo/geometry.py†L164-L217】【F:src/pneumo/cylinder.py†L107-L146】 |
| Топология системы | Наличие всех цилиндров и линий, диагональная схема | `_validate_system_configuration`, `_validate_diagonal_connections`【F:src/pneumo/system.py†L17-L88】 |
| Пневмолинии | Корректность конечных точек, давление, диагональность | `PneumoLine.validate_invariants`【F:src/pneumo/line.py†L40-L94】 |
| Ресивер | Диапазоны объёмов, давление, температура | `ReceiverSpec.validate_invariants`, `ReceiverState._validate_state`【F:src/pneumo/receiver.py†L9-L78】 |
| Клапаны | Положительность параметров, гистерезис, ограничения для типов | `CheckValve.validate_invariants`, `ReliefValve.validate_invariants`【F:src/pneumo/valves.py†L138-L170】【F:src/pneumo/valves.py†L280-L312】 |
| Газовая сеть | Неотрицательность масс, температур, давлений | `GasNetwork.validate_invariants`【F:src/pneumo/network.py†L364-L414】 |

## 9. Ограничения и допущения

1. Газ рассматривается как идеальный воздух с постоянными R и γ; влажность и теплопередача не учитываются【F:src/common/units.py†L16-L32】【F:src/pneumo/gas_state.py†L13-L190】.
2. Температура атмосферы фиксирована (293,15 K); возможные изменения окружающей среды игнорируются【F:src/common/units.py†L24-L32】.
3. Клапаны моделируются квазистационарно, без динамики привода и задержек【F:src/pneumo/valves.py†L53-L312】.
4. Потоки вычисляются по одномерным формулам для круглых дросселей; турбулентность и реальный профиль скоростей не моделируются【F:src/pneumo/flow.py†L1-L258】.
5. Главный отсечной клапан мгновенно выравнивает давления без потерь при его открытии【F:src/pneumo/network.py†L312-L362】.
6. Механика кузова/подвески не интегрирована; изменение объёмов задаётся положением рычагов, поступающим извне (`update_system_from_lever_angles`)【F:src/pneumo/system.py†L90-L132】.

## 10. Требования к реализации в Codex

1. **Чтение конфигурации**: параметры цилиндров, линий, клапанов и ресивера должны загружаться из конфигурационных файлов, соблюдая проверки инвариантов.
2. **Модульность**: обеспечить отдельные сервисы для геометрической кинематики, расчёта потоков, управления клапанами и интеграции во времени, опираясь на существующие классы.
3. **Тесты**: подготовить сценарии, проверяющие:
   - корректность диагональных соединений;
   - сохранение положительности масс/давлений при многократных шагах интеграции;
   - срабатывание гистерезиса клапанов и режимов сброса давления.
4. **Диагностика**: предоставить журналы с шагами симуляции и подробные отчёты валидации (аналогично `GasNetwork.validate_invariants`).
5. **Расширяемость**: заложить возможность добавления новых режимов термодинамики (например, политропический) и адаптивного шага `dt`.

## 11. Структура выходных данных

- История симуляции: массивы времени, давлений ресивера, масс линий и ресивера, давления линий (`run_gas_simulation`).
- Отчёты проверки: списки ошибок и предупреждений для каждого компонента.
- Диагностические логи: события открытия/закрытия клапанов, величины расхода, изменения температуры.

## 12. Приложение: базовые константы

| Константа | Значение | Комментарий |
|-----------|----------|-------------|
| PA_ATM | 101325 Па | Атмосферное давление |【F:src/common/units.py†L8-L32】|
| T_AMBIENT | 293,15 K | Температура окружающей среды |【F:src/common/units.py†L24-L32】|
| R_AIR | 287,05 Дж/(кг·К) | Газовая постоянная воздуха |【F:src/common/units.py†L16-L24】|
| GAMMA_AIR | 1,4 | Показатель адиабаты воздуха |【F:src/common/units.py†L16-L24】|
| MIN_VOLUME_FRACTION | 0,005 | Минимальная доля остаточного объёма цилиндра |【F:src/common/units.py†L28-L32】|

---

Документ может быть расширен дополнительными сценариями и матрицами тестирования по мере детализации требований к Codex.
