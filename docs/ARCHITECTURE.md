# PneumoStabSim - System Architecture

## ??? Architecture Overview

This document describes the complete system architecture of PneumoStabSim v2.0.0.

---

## ?? System Layers

### **1. Presentation Layer (UI)**

```
???????????????????????????????????????????????????????????
?                   PRESENTATION LAYER                    ?
???????????????????????????????????????????????????????????
?                                                         ?
?  ??????????????????????????????????????????????????   ?
?  ?          MainWindow (QMainWindow)              ?   ?
?  ?  - Central widget: QQuickWidget (QML)          ?   ?
?  ?  - Dock panels: Geometry, Pneumo, Modes        ?   ?
?  ?  - Status bar: Real-time metrics               ?   ?
?  ??????????????????????????????????????????????????   ?
?               ?                                         ?
?  ??????????????????????????????????????????????????   ?
?  ?          Qt Quick 3D Scene (main.qml)          ?   ?
?  ?  - View3D: 3D viewport                         ?   ?
?  ?  - Camera: Orbital control                     ?   ?
?  ?  - Models: U-Frame + 4 suspension corners      ?   ?
?  ?  - Materials: PBR (metallic, roughness)        ?   ?
?  ??????????????????????????????????????????????????   ?
?                                                         ?
???????????????????????????????????????????????????????????
```

**Key Components:**
- **MainWindow**: Qt-based window manager
- **QML Scene**: Qt Quick 3D rendering (D3D11 backend)
- **Panels**: Parameter controls (Geometry, Pneumo, Modes, Road)
- **Widgets**: Custom controls (RangeSlider, Knob)

---

### **2. Application Layer (Logic)**

```
???????????????????????????????????????????????????????????
?                  APPLICATION LAYER                      ?
???????????????????????????????????????????????????????????
?                                                         ?
?  ??????????????????????????????????????????????????   ?
?  ?         GeometryBridge (Converter)             ?   ?
?  ?  - 2D kinematics ? 3D coordinates              ?   ?
?  ?  - Piston position calculation                 ?   ?
?  ?  - Joint position calculation                  ?   ?
?  ?  - Volume calculations                         ?   ?
?  ??????????????????????????????????????????????????   ?
?                                                         ?
?  ??????????????????????????????????????????????????   ?
?  ?       SimulationManager (Controller)           ?   ?
?  ?  - Physics thread management                   ?   ?
?  ?  - State bus (signals/slots)                   ?   ?
?  ?  - State queue (latest-only)                   ?   ?
?  ??????????????????????????????????????????????????   ?
?                                                         ?
???????????????????????????????????????????????????????????
```

**Key Responsibilities:**
- **GeometryBridge**: Convert 2D mechanics ? 3D visualization
- **SimulationManager**: Coordinate physics simulation
- **State Management**: Thread-safe state communication

---

### **3. Domain Layer (Physics)**

```
???????????????????????????????????????????????????????????
?                    DOMAIN LAYER                         ?
???????????????????????????????????????????????????????????
?                                                         ?
?  ??????????????????????????????????????????????????   ?
?  ?       PhysicsWorker (QThread)                  ?   ?
?  ?  - Fixed timestep loop (1ms)                   ?   ?
?  ?  - ODE integration (Radau)                     ?   ?
?  ?  - State snapshot creation                     ?   ?
?  ??????????????????????????????????????????????????   ?
?           ?                                             ?
?  ??????????????????????????????????????????????????   ?
?  ?                       ?              ?         ?   ?
?  ?  CylinderKinematics   ? GasNetwork   ? Road    ?   ?
?  ?  - Lever angles       ? - Pressures  ? - CSV   ?   ?
?  ?  - Piston positions   ? - Flows      ? - Sin   ?   ?
?  ?  - Volumes            ? - Valves     ? - Noise ?   ?
?  ?                       ?              ?         ?   ?
?  ??????????????????????????????????????????????????   ?
?                                                         ?
???????????????????????????????????????????????????????????
```

**Physics Components:**
- **CylinderKinematics**: Lever mechanism calculations
- **GasNetwork**: Pneumatic gas flow simulation
- **RoadInput**: Road excitation generation
- **ODE Solver**: Numerical integration (SciPy)

---

## ?? Data Flow Architecture

### **Main Data Flow (60 Hz UI Loop)**

```
User Input (Qt Panel)
      ?
      ???? GeometryPanel.geometry_changed
      ?         ?
      ?         ???? MainWindow._on_geometry_changed()
      ?                   ?
      ?                   ???? QML: updateGeometry(params)
      ?                             ?
      ?                             ???? QML properties updated
      ?                                       ?
      ?                                       ???? 3D scene rebuilds
      ?
      ???? ModesPanel.animation_changed
      ?         ?
      ?         ???? MainWindow._on_animation_changed()
      ?                   ?
      ?                   ???? QML: setProperty("userAmplitude", ...)
      ?                             ?
      ?                             ???? Animation parameters updated
      ?
      ???? ModesPanel.simulation_control
                ?
                ???? SimulationManager.start_simulation()
                          ?
                          ???? PhysicsWorker (QThread starts)
```

### **Physics Simulation Loop (1000 Hz)**

```
PhysicsWorker.physics_timer (1ms)
      ?
      ???? Get road inputs
      ?         ?
      ?         ???? RoadInput.get_wheel_excitation(t)
      ?
      ???? Update kinematics
      ?         ?
      ?         ???? CylinderKinematics.update_from_angles()
      ?
      ???? Update gas system
      ?         ?
      ?         ???? GasNetwork.apply_valves_and_flows(dt)
      ?
      ???? Integrate dynamics
      ?         ?
      ?         ???? scipy.integrate.solve_ivp(f_rhs, ...)
      ?
      ???? Create state snapshot
                ?
                ???? StateSnapshot(frame, wheels, lines, tank)
                ?
                ???? Emit: state_ready signal
                          ?
                          ???? MainWindow._on_state_update(snapshot)
                                    ?
                                    ???? _update_3d_scene_from_snapshot()
                                              ?
                                              ???? Read animation params from QML
                                              ?
                                              ???? Calculate angles (sin wave)
                                              ?
                                              ???? GeometryBridge.get_corner_3d_coords()
                                              ?
                                              ???? Set QML properties (fl_angle, ...)
                                              ?
                                              ???? Call QML: updatePistonPositions()
```

---

## ?? Component Interaction

### **Python ? QML Communication**

```
???????????????????????????????????????????????????????????
?                    PYTHON SIDE                          ?
???????????????????????????????????????????????????????????
?                                                         ?
?  MainWindow (Python)                                    ?
?  ?? _qml_root_object: QObject                          ?
?  ?                                                       ?
?  ?? READ from QML:                                      ?
?  ?  ?? userAmplitude = property("userAmplitude")       ?
?  ?  ?? userFrequency = property("userFrequency")       ?
?  ?  ?? userPhaseGlobal = property("userPhaseGlobal")   ?
?  ?                                                       ?
?  ?? WRITE to QML:                                       ?
?     ?? setProperty("fl_angle", angle)                  ?
?     ?? setProperty("userPistonPositionFL", pos)        ?
?     ?? invokeMethod("updatePistonPositions", dict)     ?
?                                                         ?
???????????????????????????????????????????????????????????
                          ?
                          ? Qt Meta-Object System
                          ?
???????????????????????????????????????????????????????????
?                     QML SIDE                            ?
???????????????????????????????????????????????????????????
?                                                         ?
?  Item (main.qml)                                        ?
?  ?? Properties:                                         ?
?  ?  ?? property real userAmplitude: 8.0                ?
?  ?  ?? property real userFrequency: 1.0                ?
?  ?  ?? property real fl_angle: 0.0                     ?
?  ?  ?? property real userPistonPositionFL: 125.0       ?
?  ?                                                       ?
?  ?? Functions:                                          ?
?  ?  ?? function updateGeometry(params) { ... }         ?
?  ?  ?? function updatePistonPositions(positions) {...} ?
?  ?                                                       ?
?  ?? Bindings:                                           ?
?     ?? SuspensionCorner {                              ?
?        leverAngle: fl_angle  // Auto-updates!          ?
?        pistonPositionFromPython: userPistonPositionFL  ?
?     }                                                   ?
?                                                         ?
???????????????????????????????????????????????????????????
```

---

## ?? Threading Model

```
???????????????????????????????????????????????????????????
?                   MAIN THREAD (UI)                      ?
?  - Qt Event Loop (60 Hz)                                ?
?  - User input handling                                  ?
?  - QML rendering                                        ?
?  - State snapshot consumption                           ?
???????????????????????????????????????????????????????????
                      ?
                      ? QThread boundary
                      ?
???????????????????????????????????????????????????????????
?                 PHYSICS THREAD                          ?
?  - QTimer (1ms fixed timestep)                          ?
?  - Physics calculations                                 ?
?  - ODE integration                                      ?
?  - State snapshot production                            ?
???????????????????????????????????????????????????????????
```

**Thread Safety:**
- **Signals/Slots**: Qt::QueuedConnection for cross-thread
- **State Queue**: Latest-only queue (lock-free read)
- **No shared mutable state** between threads

---

## ?? Design Patterns Used

### **1. Model-View-Controller (MVC)**
- **Model**: Physics simulation (PhysicsWorker)
- **View**: QML 3D scene
- **Controller**: MainWindow + SimulationManager

### **2. Observer Pattern**
- **Subject**: SimulationManager.state_bus
- **Observers**: MainWindow, Panels, ChartWidget
- **Mechanism**: Qt Signals/Slots

### **3. Bridge Pattern**
- **Abstraction**: 2D kinematics
- **Implementation**: 3D visualization
- **Bridge**: GeometryBridge

### **4. Strategy Pattern**
- **Context**: ODE integration
- **Strategies**: Radau, RK45, BDF
- **Selection**: Runtime configuration

### **5. Producer-Consumer**
- **Producer**: PhysicsWorker (state snapshots)
- **Consumer**: MainWindow (UI updates)
- **Queue**: LatestOnlyQueue

---

## ?? Performance Considerations

### **Rendering Performance**
- **Target**: 60 FPS (16ms frame time)
- **Backend**: Direct3D 11 (RHI)
- **Optimization**: Property bindings (reactive updates)

### **Physics Performance**
- **Timestep**: 1ms (1000 Hz)
- **Integration**: Adaptive Radau (stiff ODEs)
- **Bottleneck**: ODE solve (~0.5ms per step)

### **Memory Management**
- **State Snapshots**: Latest-only (no accumulation)
- **QML Objects**: Managed by Qt QML engine
- **Python Objects**: Garbage collected

---

## ?? Error Handling Strategy

### **UI Thread**
- **Qt Exceptions**: Caught in event handlers
- **User Errors**: QMessageBox dialogs
- **Logging**: Python logging module

### **Physics Thread**
- **Integration Failures**: Logged, counter incremented
- **Invalid States**: Snapshot validation
- **Critical Errors**: Stop simulation, emit error signal

---

## ?? Configuration Management

### **Static Configuration**
- **Geometry Defaults**: `src/ui/panels/panel_geometry.py`
- **Physics Defaults**: `src/physics/integrator.py`
- **Pneumatic Defaults**: `src/pneumo/system.py`

### **Runtime Configuration**
- **UI State**: QSettings (persistent)
- **Simulation Parameters**: Panel widgets
- **Presets**: JSON files (save/load)

---

## ?? Deployment Architecture

```
PneumoStabSim.exe (Windows)
??? Python 3.11 (embedded)
??? PySide6 Runtime
?   ??? Qt6Core.dll
?   ??? Qt6Gui.dll
?   ??? Qt6Widgets.dll
?   ??? Qt6Qml.dll
?   ??? Qt6Quick.dll
?   ??? Qt6Quick3D.dll
?   ??? d3d11.dll (system)
??? SciPy + NumPy
??? Assets
    ??? qml/
        ??? main.qml
```

---

**Last Updated:** 2025-01-05
**Architecture Version:** 2.0.0
