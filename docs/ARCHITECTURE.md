# PneumoStabSim Professional — архитектура приложения

Документ описывает архитектуру Python-приложения, моделирующего пневматический
стабилизатор подвески. Материал структурирован по разделам спецификации
механизма и связывает каждое требование с реализацией в исходном коде.

## Обзор уровней системы

| Слой | Назначение | Основные модули |
| --- | --- | --- |
| **Интерфейс и визуализация** | Qt/QML интерфейс, 3D сцена и индикаторы состояния | `assets/qml/main.qml`, `src/PneumoStabSim.UI/*`, `src/common/logging_widgets.py` |
| **Прикладная логика** | Управление симуляцией, связывание настроек, коммуникация UI ↔ физика | `src/app/config_defaults.py`, `src/core/settings_manager.py`, `src/app/smoke_gas.py`, `src/physics/integrator.py` |
| **Доменная модель** | Геометрия подвески, газодинамика, интеграторы движения | `src/core/geometry.py`, `src/pneumo/*`, `src/physics/forces.py`, `src/physics/odes.py` |
| **Инфраструктура** | Конфигурация, диагностика, журналирование | `config/app_settings.json`, `src/common/logging_setup.py`, `src/common/settings_requirements.py` |

Слои взаимодействуют через шину состояний: физический расчёт публикует
снимки (`PhysicsSnapshot` в `src/physics/integrator.py`), а UI потребляет их для
обновления 3D сцены и графиков.

## I. Элементы конструкции

### Рама
- Представлена как неподвижная система координат в `src/core/geometry.py`.
- Геометрические константы (позиции шарниров, смещения) загружаются через
  `config/constants.py` и проксируются классом `GeometryParams`.

### Рычаги (4 шт.)
- Моделируются компонентом `LeverState` в `src/pneumo/geometry.py`, который
  хранит длину, угол и точки крепления.
- Визуализация рычага выполняется QML-компонентами `SuspensionCorner` в
  `assets/qml/main.qml`.

### Пневмоцилиндр, поршень, шток и хвостовик
- Класс `CylinderSpec` определяет размеры, `CylinderState` хранит текущее
  положение и вычисляет объёмы (`vol_head`, `vol_rod`). Расположено в
  `src/pneumo/cylinder.py`.
- Функция `update_from_lever_angle()` преобразует угол рычага в ход штока.
- Пограничные условия (мертвые зоны) учитываются при расчётах объёмов и
  проверяются `CylinderState.validate_invariants()`.

### Пружина и амортизатор
- Пружина описана в `src/physics/forces.py` (класс `SpringForceModel`).
- Демпфирование реализовано классом `DamperForceModel` в том же файле и может
  быть отключено через настройки.

### Ресивер
- Состояние ресивера описывает `ReceiverState` (`src/pneumo/receiver.py`),
  включающий давление, объём и температуру.

### Пневмолинии
- Каждая линия (`A1`, `A2`, `B1`, `B2`) представлена `PneumoLine` в
  `src/pneumo/line.py`. Конфигурация линий хранится в перечислении `Line`.

### Клапаны и кран
- Классы `CheckValve` и `ReliefValve` находятся в `src/pneumo/valves.py`.
- Состояние межлинейного крана (`master_isolation_open`) включено в модель
  `PneumaticSystem` (`src/pneumo/system.py`).

## II. Схема соединений

- Диагональная схема соединений жёстко проверяется методом
  `_validate_diagonal_connections()` в `PneumaticSystem` (`src/pneumo/system.py`).
- Механические шарниры реализуются как расчётные точки: функции `lever_tip()` и
  `rod_anchor()` в `src/pneumo/geometry.py` задают координаты креплений к раме и
  рычагу.
- Визуально соединения отображаются в QML как родственные узлы `Model` внутри
  `assets/qml/main.qml`, где цилиндры, штоки и пружины соосны и связаны
  трансформациями.

## III. Движение и граничные условия

- Основной расчёт кинематики выполняет `CylinderState.update_from_lever_angle()`
  совместно с функциями `resolve_linkage()` в `src/pneumo/geometry.py`.
- Ограничение хода поршня: `CylinderSpec.stroke_m` и мёртвые зоны обрезают
  доступный диапазон, что отражено в проверках `validate_invariants()`.
- Рычаги вращаются в плоскости, углы хранятся в `LeverState.angle_rad`.
- Центры масс используются в динамике (`src/physics/odes.py`) для расчёта
  инерционных сил.

## IV. Допущения

- Модели элементов рассматриваются одномерными; класс `RigidBody1D` в
  `src/physics/odes.py` оперирует линейными степенями свободы.
- Трение в шарнирах отсутствует — силы трения не учитываются в `forces.py`.
- Переключение демпфирования и жёсткости осуществляется настройками
  `simulation.enable_dampers` и `simulation.enable_springs` в `config/app_settings.json`.
- Режим кинематики/динамики переключается флагом `simulation.mode` и обрабатывается
  в `SimulationMode` (`src/physics/integrator.py`).
- Тип термодинамического процесса задаётся `gas.gamma_mode` и влияет на функции в
  `src/pneumo/thermo.py`.
- Объём линий приравнивается к нулю — `PneumoLine.volume_lag_m3` используется только
  для учёта соединений цилиндров.

## V. Параметры

- Все исходные величины загружаются через `config/app_settings.json`, схема
  описана в `config/schemas/app_settings.schema.json` и валидируется
  `src/core/settings_validation.py`.
- Класс `SettingsManager` (`src/core/settings_manager.py`) предоставляет доступ к
  параметрам UI, а `src/app/config_defaults.py` определяет значения по умолчанию.
- Расчётные параметры (ход рычага, длина штока, давление в ресивере) вычисляются
  в `src/physics/integrator.py` и публикуются как часть `PhysicsSnapshot`.
- Жёсткости пружин подбираются методом `SpringForceModel.configure_from_geometry()`
  на основе исходных геометрических данных.
- Массы компонентов настраиваются через блок `mass` в конфиге и участвуют в
  матрицах масс (`src/physics/odes.py`).

## VI. Газодинамика

- Расчёт термодинамических величин выполняется в `src/pneumo/thermo.py`.
- Расходы через линии и клапаны вычисляются функциями `orifice_flow_rate()` и
  `apply_valve_flow()` в `src/pneumo/flow.py`.
- Управление клапанами обрабатывает `src/pneumo/network.py`, который обновляет
  состояния `LineGasState` и `TankGasState` (`src/pneumo/gas_state.py`).
- Предохранительные клапаны контролируют превышение `P_max`, см. метод
  `ReliefValve.release_flow()`.
- Изменение давления в ресивере выполняет `ReceiverState.update_from_mass_flow()`.

## VII. Алгоритмы

1. **Кинематика рычагов** — модуль `src/pneumo/geometry.py` вычисляет углы рычагов
   по заданным смещениям колёс и получает координаты точек подвески.
2. **Перемещение поршней** — `CylinderState.update_from_lever_angle()` обновляет ход
   штока и объёмы полостей.
3. **Перерасчёт давлений** — `src/pneumo/thermo.py::adiabatic_pressure()` и
   `isothermal_pressure()` применяются в `src/pneumo/network.py` в зависимости от
   выбранного режима `gamma`.
4. **Силы пружин и амортизаторов** — реализованы в `src/physics/forces.py`, где
   учитываются натяги и демпфирование.
5. **Обновление ресивера** — `src/pneumo/receiver.py` интегрирует массу воздуха,
   поступающую через клапаны.
6. **Интегратор динамики** — основной цикл в `src/physics/integrator.py` вызывает
   правые части ОДУ из `src/physics/odes.py` и использует SciPy (`Radau`, `RK45`)
   для интегрирования.
7. **Проверки ограничений** — `PneumaticSystem.validate_invariants()` и проверки
   в `src/physics/integrator.py` гарантируют физические диапазоны. UI блокирует
   некорректный ввод через `src/common/settings_requirements.py`.

## VIII. Графическое отображение

- 3D сцена описана в `assets/qml/main.qml`: цилиндры, рычаги, пружины и амортизаторы
  масштабируются согласно параметрам из Python через свойства QML.
- Расширенная среда визуализации управляется компонентом
  `assets/qml/effects/SceneEnvironmentController.qml`, который конфигурирует
  `ExtendedSceneEnvironment` (HDR IBL, тонмаппинг, bloom, SSAO, туман) и теперь
  поддерживает автофокусировку глубины резкости: фокус и диапазон автоматически
  подстраиваются под текущую орбитальную камеру через биндинги в
  `PneumoStabSim/SimulationRoot.qml`.
- Цветовая индикация давления реализована шейдерами и свойством `linePressure` для
  каждой трубки, которое обновляется из Python (`src/PneumoStabSim.UI/pressure_bridge.py`).
- Анимированные стрелки потоков создаются компонентом `FlowIndicator.qml` и
  управляются скоростью из `PhysicsSnapshot`.
- Ресивер визуализируется моделью `ReceiverIndicator` с прозрачным материалом и
  шкалой давления (градиентный столбец QML).
- Состояния клапанов отображаются иконками с подсветкой; Python отправляет флаги
  через сигнал `updateValveStates` (`src/PneumoStabSim.UI/signals.py`).
- Обновления выполняются плавно благодаря интерполяции свойств (анимации в QML) и
  стабилизирующему буферу `LatestOnlyQueue` между потоками.
- Параметры освещения и постобработки вынесены в модуль `assets/qml/environment`,
  где `RealismEnvironment.qml` настраивает HDR-окружение, тон-маппинг, туман,
  SSAO, Bloom и глубину резкости через типизированные свойства, доступные Python.
- Локальные отражения управляются компонентом `ReflectionProbeVolume.qml`, а
  источники света сгруппированы в `lighting/RealismLightingRig.qml`, что упрощает
  управление тенями и насыщенностью освещения из единой точки.
- Экспозиция, параметры тумана, антиалиасинг и прочие визуальные настройки
  синхронизируются с Python через пакетные обновления, поэтому UI мгновенно
  отражает изменения без рывков и потери производительности.

## IX. Интерфейс пользователя

- Панели управления реализованы в `assets/qml/panels/*.qml` и связываются с Python
  через `src/PneumoStabSim.UI/panels`. Основные группы параметров:
  - **Геометрия** — длины рычагов, ход поршня.
  - **Пневматика** — давления, объёмы, настройки клапанов.
  - **Режимы** — кинематика/динамика, адиабата/изотерма, включение стабилизатора.
  - **Воздействия** — амплитуда, частота и фаза для каждого рычага; пресеты дороги.
- Проверка ввода реализована комбинацией QML-валидаторов и Python-проверок в
  `src/core/settings_validation.py`.
- Отдельные переключатели позволяют отключать пружины, амортизаторы и
  диагональную связь (`master_isolation_open`).
- Живые графики построены на PyQtGraph (`src/PneumoStabSim.UI/charts.py`) и могут
  отображать давление, ход подвески и ускорения.

## X. Потоки данных и исполнение

1. Пользователь изменяет параметр в UI → сигнал QML вызывает слот Python
   (`MainWindow._on_settings_changed` в `src/PneumoStabSim.UI/main_window.py`).
2. `SettingsManager` обновляет конфигурацию и передаёт её в `SimulationController`
   (`src/app/smoke_gas.py`).
3. В динамическом режиме `PhysicsWorker` (`src/physics/integrator.py`) запускает
   цикл интеграции с фиксированным шагом, обновляя состояния рычагов, цилиндров и
   газовой сети.
4. После каждого шага формируется `PhysicsSnapshot`, который помещается в
   `LatestOnlyQueue` и передаётся в UI через сигнал `state_ready`.
5. UI обновляет 3D сцену, индикаторы и графики, используя данные снимка.

Система построена таким образом, чтобы каждое изменение входных данных
автоматически инициировало полный пересчёт связанных параметров и обновление
визуализации, гарантируя физическую и визуальную целостность модели.
