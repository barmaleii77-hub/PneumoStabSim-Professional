# План реструктуризации большихфайлов проекта

## Статус: В процессе 🔨

Автоматически сгенерирован на основе анализа кодовой базы.

## Цели реструктуризации

1. **Уменьшить размер файлов** до < 500 строк для лучшей поддержки
2. **Разделить обязанности** по принципу Single Responsibility
3. **Улучшить тестируемость** за счёт изоляции модулей
4. **Упростить навигацию** по кодовой базе

## Файлы требующие реструктуризации

### 🔴 Критические (> 1000 строк)

| Файл | Строк | Приоритет | Статус |
|------|-------|-----------|--------|
| `panel_graphics.py` | 2360 | ⭐⭐⭐ | 🔨 В процессе |
| `main_window.py` | 1053 | ⭐⭐⭐ | 📋 Запланирован |

### 🟡 Средние (500-1000 строк)

| Файл | Строк | Приоритет | Статус |
|------|-------|-----------|--------|
| `panels_accordion.py` | 876 | ⭐⭐ | 📋 Запланирован |
| `panel_geometry.py` | 791 | ⭐⭐ | 📋 Запланирован |
| `panel_pneumo.py` | 767 | ⭐⭐ | 📋 Запланирован |
| `sim_loop.py` | 722 | ⭐⭐ | 📋 Запланирован |
| `panel_modes.py` | 665 | ⭐ | 📋 Запланирован |

## План действий

### Фаза 1: Graphics Panel (✅ Начато)

**Цель**: Разделить `panel_graphics.py` (2360 строк) на 10 модулей

```
src/ui/panels/graphics/
├── __init__.py              ✅ Создан
├── README.md                ✅ Создан  
├── widgets.py               ✅ Создан (ColorButton, LabeledSlider)
├── defaults.py              ✅ Создан (настройки по умолчанию)
├── lighting_tab.py          ✅ Создан (вкладка освещения)
├── environment_tab.py       🔨 TODO (фон, IBL, туман, AO)
├── quality_tab.py           🔨 TODO (тени, AA, рендер)
├── camera_tab.py            🔨 TODO (камера)
├── materials_tab.py         🔨 TODO (материалы PBR)
├── effects_tab.py           🔨 TODO (bloom, DOF, etc)
├── state_manager.py         🔨 TODO (состояние, настройки)
└── panel_graphics.py        🔨 TODO (рефакторинг координатора)
```

**Прогресс**: 4/11 файлов (36%)

### Фаза 2: Main Window

**Цель**: Разделить `main_window.py` (1053 строки)

Предлагаемая структура:

```
src/ui/main_window/
├── __init__.py              # Экспорт MainWindow
├── main_window.py           # Главный класс (< 300 строк)
├── ui_setup.py              # Построение UI
├── qml_bridge.py            # Python ↔ QML коммуникация
├── simulation_handlers.py  # Обработчики симуляции
├── menu_toolbar.py          # Меню и тулбар
└── state_persistence.py     # Сохранение/восстановление состояния
```

### Фаза 3: Panels Accordion

**Цель**: Разделить `panels_accordion.py` (876 строк)

```
src/ui/panels/accordion/
├── __init__.py
├── geometry_panel.py        # GeometryPanelAccordion
├── pneumo_panel.py          # PneumoPanelAccordion
├── simulation_panel.py      # SimulationPanelAccordion
├── road_panel.py            # RoadPanelAccordion
└── advanced_panel.py        # AdvancedPanelAccordion
```

### Фаза 4: Geometry Panel

**Цель**: Разделить `panel_geometry.py` (791 строка)

```
src/ui/panels/geometry/
├── __init__.py
├── panel_geometry.py        # Главный класс
├── widgets.py               # RangeSlider и кастомные виджеты
├── validators.py            # Валидация геометрии
├── dependencies.py          # Разрешение конфликтов параметров
└── presets.py               # Пресеты геометрии
```

### Фаза 5: Pneumo Panel

**Цель**: Разделить `panel_pneumo.py` (767 строк)

```
src/ui/panels/pneumo/
├── __init__.py
├── panel_pneumo.py          # Главный класс
├── cylinder_group.py        # Параметры цилиндров
├── valves_group.py          # Управление клапанами
├── thermo_group.py          # Термодинамика
└── pressure_widgets.py      # Виджеты давления
```

## Принципы реструктуризации

### 1. Размер файла
- ✅ **Целевой размер**: < 500 строк
- ⚠️ **Допустимо**: < 700 строк для главных классов
- ❌ **Недопустимо**: > 1000 строк

### 2. Обязанности
- Один файл = одна чёткая обязанность
- Минимизировать связанность между модулями
- Максимизировать связность внутри модуля

### 3. Иерархия
```
src/ui/panels/
├── panel_geometry.py          # Старый стиль (будет мигрирован)
├── geometry/                  # Новый стиль (модульный)
│   ├── __init__.py
│   ├── panel_geometry.py      # Координатор
│   └── ... (модули)
└── graphics/                  # ✅ Уже модульный
    ├── __init__.py
    ├── panel_graphics.py      # Координатор
    └── ... (модули)
```

### 4. Обратная совместимость
- Импорты остаются прежними: `from src.ui.panels import GraphicsPanel`
- `__init__.py` реэкспортирует главные классы
- Внутренняя реорганизация прозрачна для пользователей

## Метрики успеха

### До реструктуризации
- 📊 Средний размер файла: **980 строк** (топ-10 файлов)
- 📊 Максимальный файл: **2360 строк** (`panel_graphics.py`)
- 📊 Файлов > 1000 строк: **2**
- 📊 Файлов > 500 строк: **7**

### После реструктуризации (цель)
- 🎯 Средний размер файла: **< 400 строк**
- 🎯 Максимальный файл: **< 700 строк**
- 🎯 Файлов > 1000 строк: **0**
- 🎯 Файлов > 500 строк: **< 3**

## Процесс миграции

### Шаги для каждого файла:

1. **Анализ** 📖
   - Прочитать код и выделить логические блоки
   - Определить зависимости между блоками
   - Спланировать структуру модулей

2. **Создание модулей** 🔨
   - Создать структуру папок
   - Выделить переиспользуемые компоненты (widgets, defaults)
   - Создать специализированные модули (tabs, handlers)

3. **Рефакторинг главного класса** ♻️
   - Заменить встроенную логику на вызовы модулей
   - Сохранить публичный API (обратная совместимость)
   - Обновить импорты

4. **Тестирование** ✅
   - Проверить работоспособность
   - Убедиться в отсутствии регрессий
   - Запустить существующие тесты

5. **Документация** 📝
   - Обновить docstrings
   - Создать README для модуля
   - Документировать изменения

6. **Удаление старого кода** 🗑️
   - После успешной миграции удалить старый монолитный файл
   - Обновить импорты в других частях проекта

## Текущий прогресс

### Общий прогресс: 20%

- ✅ **Фаза 1** (Graphics Panel): 36% завершено (4/11 файлов)
- 📋 **Фаза 2** (Main Window): Запланирована
- 📋 **Фаза 3** (Panels Accordion): Запланирована
- 📋 **Фаза 4** (Geometry Panel): Запланирована
- 📋 **Фаза 5** (Pneumo Panel): Запланирована

## Следующие шаги

1. ✅ Завершить `environment_tab.py` для Graphics Panel
2. ✅ Завершить `quality_tab.py` для Graphics Panel
3. ✅ Завершить `camera_tab.py` для Graphics Panel
4. ✅ Завершить `materials_tab.py` для Graphics Panel
5. ✅ Завершить `effects_tab.py` для Graphics Panel
6. ✅ Создать `state_manager.py` для Graphics Panel
7. ✅ Рефакторить `panel_graphics.py` как координатор
8. 🔄 Перейти к Фазе 2 (Main Window)

---

**Последнее обновление**: 2024 (автоматически сгенерирован)
