# Модульная структура GraphicsPanel

## Обзор реструктуризации

Огромный файл `panel_graphics.py` (2360 строк) был разделён на логические модули для улучшения поддержки и читаемости кода.

## Новая структура

```
src/ui/panels/graphics/
├── __init__.py              # Экспорт основного класса GraphicsPanel
├── README.md                # Этот файл - документация структуры
├── widgets.py               # Переиспользуемые виджеты (ColorButton, LabeledSlider)
├── defaults.py              # Настройки по умолчанию и пресеты качества
├── lighting_tab.py          # Вкладка освещения
├── environment_tab.py       # Вкладка окружения (fog, IBL, AO)
├── quality_tab.py           # Вкладка качества (shadows, AA, render)
├── camera_tab.py            # Вкладка камеры
├── materials_tab.py         # Вкладка материалов
├── effects_tab.py           # Вкладка эффектов (bloom, DOF, etc)
├── scene_tab.py             # Управление сценой и цветокоррекцией
├── state_manager.py         # Управление состоянием и настройками
└── panel_graphics.py        # Главный класс-координатор
```

> Исторический `panel_graphics_refactored.py` сохранён как совместимый импорт,
> перенаправляющий в актуальный `panel_graphics.py`.

## Разделение обязанностей

### widgets.py (✅ Создан)
- `ColorButton` - кнопка выбора цвета с диалогом
- `LabeledSlider` - слайдер с подписью и спинбоксом

### defaults.py (✅ Создан)
- `build_defaults()` - дефолтные настройки графики
- `build_quality_presets()` - пресеты качества (ultra/high/medium/low)
- Дефолты материалов для всех компонентов

### lighting_tab.py (✅ Создан)
- `LightingTab` - вкладка с контролами освещения
- Ключевой, заполняющий, контровой, точечный свет
- Пресеты освещения (дневной/ночной/промышленный)

### environment_tab.py (✅ Реализовано)
- `EnvironmentTab` - вкладка окружения (фон, IBL, туман, Ambient Occlusion)
- Контролирует HDR-файлы, интенсивность тумана и параметры AO

### quality_tab.py (✅ Реализовано)
- `QualityTab` - вкладка качества (тени, сглаживание, рендеринг)
- Управляет профилями качества, выбором TAA/SSAA/FXAA и разрешением рендера

### camera_tab.py (✅ Реализовано)
- `CameraTab` - управление FOV, near/far clipping и скоростью камеры
- Добавлены переключатели автоповорота и инверсии управления

### materials_tab.py (✅ Реализовано)
- `MaterialsTab` - редактор PBR-параметров для рамы, рычагов, цилиндров и поршней
- Работает с `GraphicsStateManager` и обновляет JSON-состояние

### effects_tab.py (✅ Реализовано)
- `EffectsTab` - эффекты постобработки (Bloom, DOF, Motion Blur, Vignette)
- Содержит отдельный переключатель цветокоррекции с логированием

### scene_tab.py (✅ Реализовано)
- Управление цветовыми профилями сцены, экспозицией и вспомогательными материалами
- Позволяет синхронизировать цветокоррекцию между Python и QML

### state_manager.py (✅ Реализовано)
- `GraphicsStateManager` - загрузка/сохранение настроек через SettingsManager
- Отвечает за миграцию и фиксацию дефолтов без автосохранения

### panel_graphics.py (✅ Готово)
- `GraphicsPanel` - главный координатор табов
- Создаёт вкладки, агрегирует сигналы и реализует `collect_state()`
- Использует `GraphicsSettingsService` и журналирует операции

## Преимущества новой структуры

✅ **Читаемость**: Каждый файл < 500 строк
✅ **Тестируемость**: Модули можно тестировать изолированно
✅ **Поддержка**: Легко найти нужный код
✅ **Переиспользование**: Виджеты можно использовать в других панелях
✅ **Параллельная разработка**: Разные разработчики могут работать над разными вкладками

## Миграция

`src/ui/panels/panel_graphics.py` теперь тонкая обёртка, перенаправляющая в
`graphics/panel_graphics.py`. Исторический модуль
`panel_graphics_refactored.py` сохранён как shim для совместимости импортов.

## Статус

- [x] widgets.py - базовые виджеты ✅
- [x] defaults.py - настройки по умолчанию ✅
- [x] lighting_tab.py - освещение ✅
- [x] environment_tab.py - окружение ✅
- [x] quality_tab.py - качество ✅
- [x] camera_tab.py - камера ✅
- [x] materials_tab.py - материалы ✅
- [x] effects_tab.py - эффекты ✅
- [x] state_manager.py - управление состоянием ✅
- [x] panel_graphics.py - координатор табов ✅

**Прогресс: 100%** ████████████████████

**Создано модулей:** 11/11
**Было:** 2662 строки в 1 файле
**Стало:** ~3100 строк в 11 файлах (средний размер: 280 строк)
**Результат:** графическая панель полностью модульная, сборка состояния выполняется через `collect_state()`.
