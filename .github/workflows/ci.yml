name: Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.13"
  QT_VERSION: "6.10.0"
  QT_QPA_PLATFORM: offscreen
  QT_QUICK_BACKEND: software
  LIBGL_ALWAYS_SOFTWARE: "1"
  MESA_GL_VERSION_OVERRIDE: "4.1"
  MESA_GLSL_VERSION_OVERRIDE: "410"

jobs:
  quality:
    name: Quality gate (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    env:
      QT_QPA_PLATFORM: ${{ env.QT_QPA_PLATFORM }}
      QT_QUICK_BACKEND: ${{ env.QT_QUICK_BACKEND }}
      LIBGL_ALWAYS_SOFTWARE: ${{ env.LIBGL_ALWAYS_SOFTWARE }}
      MESA_GL_VERSION_OVERRIDE: ${{ env.MESA_GL_VERSION_OVERRIDE }}
      MESA_GLSL_VERSION_OVERRIDE: ${{ env.MESA_GLSL_VERSION_OVERRIDE }}
      PYTHONPATH: src
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install headless Qt Quick dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb xauth dbus-x11 \
            mesa-utils mesa-utils-extra \
            libgl1 libgl1-mesa-dri libgl1-mesa-glx libglu1-mesa libglu1-mesa-dev \
            libegl1 libegl1-mesa libegl1-mesa-dev libgles2-mesa libgles2-mesa-dev \
            libosmesa6 libosmesa6-dev libgbm1 libdrm2 \
            libxcb-xinerama0 libxkbcommon0 libxkbcommon-x11-0 \
            libxcb-keysyms1 libxcb-image0 libxcb-icccm4 libxcb-render-util0 libxcb-xfixes0 libxcb-shape0 libxcb-randr0 libxcb-glx0 \
            libvulkan1 mesa-vulkan-drivers vulkan-tools

      - name: Install GNU Make (Windows)
        if: runner.os == 'Windows'
        run: choco install make --no-progress -y

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements*.txt
            pyproject.toml

      - name: Upgrade pip and install tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv aqtinstall

      - name: Install project dependencies
        run: python -m pip install -r requirements-dev.txt

      - name: Provision Qt ${{ env.QT_VERSION }}
        run: python tools/setup_qt.py --qt-version ${{ env.QT_VERSION }} --force --prune-archives

      - name: Export Qt paths
        shell: python
        run: |
          import os
          import platform
          from pathlib import Path

          version = os.environ["QT_VERSION"]
          root = Path.cwd() / "Qt" / version
          system = platform.system().lower()
          if system == "windows":
              arch = "win64_msvc2019_64"
          elif system == "linux":
              arch = "gcc_64"
          else:
              arch = "clang_64"

          base = root / arch
          bin_path = base / "bin"
          plugin_path = base / "plugins"
          qml_path = base / "qml"

          github_path = Path(os.environ["GITHUB_PATH"])
          with github_path.open("a", encoding="utf-8") as fh:
              fh.write(f"{bin_path}{os.linesep}")

          github_env = Path(os.environ["GITHUB_ENV"])
          with github_env.open("a", encoding="utf-8") as fh:
              fh.write(f"QT_PLUGIN_PATH={plugin_path}{os.linesep}")
              fh.write(f"QML2_IMPORT_PATH={qml_path}{os.linesep}")

      - name: Run make check
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            bash scripts/xvfb_wrapper.sh make check
          else
            make check
          fi

      - name: Audit shader logs
        run: python tools/check_shader_logs.py reports/shaders --recursive --expect-fallback

      - name: Publish shader warnings
        if: always()
        shell: bash
        run: |
          if [[ -f reports/warnings.log ]]; then
            if [[ -s reports/warnings.log ]]; then
              while IFS= read -r line; do
                echo "::warning::${line}"
              done < reports/warnings.log
            else
              echo "No shader warnings recorded."
            fi
          else
            echo "warnings log not found"
          fi

      - name: Generate AI failure report
        if: failure()
        shell: bash
        run: |
          python - <<'PY'
          import pathlib
          import subprocess
          import sys

          reports_dir = pathlib.Path("reports/quality")
          reports_dir.mkdir(parents=True, exist_ok=True)
          output_path = reports_dir / "ai_failure_report.log"

          result = subprocess.run(
              [sys.executable, "analyze_logs.py"],
              capture_output=True,
              text=True,
          )

          payload = result.stdout
          if result.stderr:
              payload += "\n" + result.stderr

          output_path.write_text(payload, encoding="utf-8")

          sys.stdout.write(result.stdout)
          if result.stderr:
              sys.stderr.write(result.stderr)
          if result.returncode != 0:
              sys.stdout.write(
                  f"\n[ci] analyze_logs.py exited with status {result.returncode}; continuing for diagnostics.\n"
              )
          PY

      - name: Upload quality artefacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-${{ matrix.os }}
          path: |
            reports/quality/**
            reports/environment/**
            reports/tests/**
            logs/**
          if-no-files-found: warn
