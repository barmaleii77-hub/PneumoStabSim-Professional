name: Windows smoke test

on:
  push:
    branches: [main, develop, 'feature/*', 'feature/hdr-assets-migration']
  pull_request:
    branches: [main, develop, 'feature/*', 'feature/hdr-assets-migration']
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.13"
  QT_VERSION: "6.10.0"
  QT_QPA_PLATFORM: offscreen
  QT_QUICK_BACKEND: rhi
  QT_OPENGL: software
  QSG_RHI_BACKEND: d3d11
  PSS_ENV_PRESET: trace

jobs:
  smoke:
    name: Windows headless smoke
    runs-on: windows-latest
    env:
      PYTHONPATH: src
      QT_QPA_PLATFORM: ${{ env.QT_QPA_PLATFORM }}
      QT_QUICK_BACKEND: ${{ env.QT_QUICK_BACKEND }}
      QT_OPENGL: ${{ env.QT_OPENGL }}
      QSG_RHI_BACKEND: ${{ env.QSG_RHI_BACKEND }}
      PSS_ENV_PRESET: ${{ env.PSS_ENV_PRESET }}
    steps:
      - name: Checkout repository
        # Pin to actions/checkout v4.3.0 from the official GitHub Actions repository.
        # Release notes: https://github.com/actions/checkout/releases/tag/v4.3.0
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Ensure GNU Make is available
        run: choco install make --no-progress -y

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        # Pin to actions/setup-python v5.6.0 from the official GitHub Actions repository.
        # Release notes: https://github.com/actions/setup-python/releases/tag/v5.6.0
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements*.txt
            pyproject.toml

      - name: Set up uv
        # Pin to astral-sh/setup-uv v3 from the official astral-sh repository.
        # Release notes: https://github.com/astral-sh/setup-uv/releases/tag/v3
        uses: astral-sh/setup-uv@8d55fbecc275b1c35dbe060458839f8d30439ccf

      - name: Upgrade pip and install tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install aqtinstall

      - name: Discover available Qt versions
        run: |
          python -m aqt list-qt windows desktop
          python -m aqt list-qt linux desktop

      - name: Install project dependencies
        run: uv sync --frozen --extra dev

      - name: Run Windows dependency bootstrap
        shell: pwsh
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
          ./scripts/setup_windows.ps1 -SkipUvSync

      - name: Provision Qt ${{ env.QT_VERSION }}
        run: python tools/setup_qt.py --qt-version ${{ env.QT_VERSION }} --force --prune-archives

      - name: Export Qt paths
        shell: python
        run: |
          import os
          from pathlib import Path

          version = os.environ["QT_VERSION"]
          root = Path.cwd() / "Qt" / version
          arch = "win64_msvc2019_64"

          base = root / arch
          bin_path = base / "bin"
          plugin_path = base / "plugins"
          qml_path = base / "qml"

          github_path = Path(os.environ["GITHUB_PATH"])
          with github_path.open("a", encoding="utf-8") as fh:
              fh.write(f"{bin_path}{os.linesep}")

          github_env = Path(os.environ["GITHUB_ENV"])
          with github_env.open("a", encoding="utf-8") as fh:
              fh.write(f"QT_PLUGIN_PATH={plugin_path}{os.linesep}")
              fh.write(f"QML2_IMPORT_PATH={qml_path}{os.linesep}")

      - name: Prepare logs directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path logs -Force | Out-Null

      - name: Run headless smoke test (safe mode)
        shell: pwsh
        env:
          QT_QPA_PLATFORM: ${{ env.QT_QPA_PLATFORM }}
          QT_QUICK_BACKEND: ${{ env.QT_QUICK_BACKEND }}
          QT_OPENGL: ${{ env.QT_OPENGL }}
          QSG_RHI_BACKEND: ${{ env.QSG_RHI_BACKEND }}
          PSS_ENV_PRESET: ${{ env.PSS_ENV_PRESET }}
        run: |
          Set-StrictMode -Version Latest
          Write-Host "Launching PneumoStabSim in safe mode to validate DirectX fallback."
          $logPath = Join-Path (Get-Location) "logs/windows-smoke.log"
          $ErrorActionPreference = "Stop"
          & python app.py --test-mode --safe-mode *> $logPath
          $exitCode = $LASTEXITCODE
          Get-Content $logPath
          if ($exitCode -ne 0) {
            exit $exitCode
          }

      - name: Run final readiness test
        shell: pwsh
        env:
          QT_QPA_PLATFORM: ${{ env.QT_QPA_PLATFORM }}
          QT_QUICK_BACKEND: ${{ env.QT_QUICK_BACKEND }}
          QT_OPENGL: ${{ env.QT_OPENGL }}
          QSG_RHI_BACKEND: ${{ env.QSG_RHI_BACKEND }}
          PSS_ENV_PRESET: ${{ env.PSS_ENV_PRESET }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          Write-Host "Running final readiness validation under headless Qt"
          & python final_readiness_test.py
          if ($LASTEXITCODE -ne 0) {
            throw "Final readiness test failed with exit code $LASTEXITCODE"
          }

      - name: Upload smoke logs
        if: always()
        # Pin to actions/upload-artifact v4.6.2 from the official GitHub Actions repository.
        # Release notes: https://github.com/actions/upload-artifact/releases/tag/v4.6.2
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: windows-smoke-logs
          path: logs/
          if-no-files-found: warn
