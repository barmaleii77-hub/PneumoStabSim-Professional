name: Branch Audit

on:
  schedule:
    - cron: '0 4 * * 1'
  push:
    branches:
      - main
      - develop
      - 'feature/*'
      - 'feature/hdr-assets-migration' # ensure HDR assets migration branch stays monitored
  pull_request:
    branches:
      - main
      - develop
      - 'feature/*'
      - 'feature/hdr-assets-migration' # ensure HDR assets migration branch stays monitored on PRs
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  branch-audit:
    name: Detect stale branches
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/github/gh-cli:2.48.0
    env:
      THRESHOLD_DAYS: "30"
      PROTECTED_BRANCHES: main,develop
      ISSUE_LABEL: branch-audit
    steps:
      - name: Install Python
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y python3
      - name: Analyse branch freshness
        env:
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
          GH_TOKEN: ${{ github.token }}
          GITHUB_API_URL: ${{ github.api_url }}
          REPO: ${{ github.repository }}
        run: |
          python3 <<'PY'
          import json
          import os
          import sys
          import urllib.error
          import urllib.parse
          import urllib.request
          from datetime import datetime, timedelta, timezone
          from pathlib import Path

          def fail(message: str) -> None:
              print(f"::error::{message}")
              sys.exit(1)

          api_url = os.environ.get("GITHUB_API_URL", "https://api.github.com").rstrip("/")
          token = os.environ.get("GH_TOKEN")
          repo = os.environ.get("REPO")
          if not token or not repo:
              fail("Missing authentication context for branch audit.")

          try:
              threshold_days = int(os.environ.get("THRESHOLD_DAYS", "30"))
          except ValueError as exc:
              fail(f"Invalid THRESHOLD_DAYS value: {exc}")

          protected_branches = {
              branch.strip()
              for branch in os.environ.get("PROTECTED_BRANCHES", "").split(",")
              if branch.strip()
          }
          issue_label = os.environ.get("ISSUE_LABEL", "branch-audit")

          headers = {
              "Authorization": f"token {token}",
              "Accept": "application/vnd.github+json",
              "User-Agent": "branch-audit-script",
          }

          def api_request(path: str) -> dict:
              url = f"{api_url}/{path.lstrip('/') }"
              req = urllib.request.Request(url, headers=headers)
              try:
                  with urllib.request.urlopen(req) as resp:
                      if resp.status >= 400:
                          fail(f"GitHub API request failed: {resp.status} {resp.reason}")
                      return json.load(resp)
              except urllib.error.HTTPError as exc:
                  fail(f"GitHub API error: {exc}")
              except urllib.error.URLError as exc:
                  fail(f"Network error when calling GitHub API: {exc}")

          def days_since(timestamp: str) -> int:
              dt = datetime.fromisoformat(timestamp.rstrip("Z")).replace(tzinfo=timezone.utc)
              return (datetime.now(timezone.utc) - dt).days

          def filter_stale(branches: list[dict], threshold: int) -> list[dict]:
              stale = []
              for branch in branches:
                  name = branch.get("name")
                  if not name or name in protected_branches:
                      continue

                  commit = branch.get("commit", {})
                  commit_url = commit.get("url")
                  if not commit_url:
                      continue

                  commit_data = api_request(commit_url.replace(api_url + "/", ""))
                  last_commit_date = commit_data.get("commit", {}).get("committer", {}).get("date")
                  if not last_commit_date:
                      continue

                  age_days = days_since(last_commit_date)
                  if age_days >= threshold:
                      stale.append({
                          "name": name,
                          "age_days": age_days,
                          "last_commit": last_commit_date,
                      })
              return stale

          branches = api_request(f"repos/{repo}/branches?per_page=100")
          stale_branches = filter_stale(branches, threshold_days)

          summary_lines = []
          if not stale_branches:
              summary_lines.append("All branches are fresh. No action required.")
          else:
              summary_lines.append("The following branches appear stale:")
              for branch in sorted(stale_branches, key=lambda b: b["age_days"], reverse=True):
                  summary_lines.append(
                      f"- {branch['name']}: {branch['age_days']} days since last commit (last at {branch['last_commit']})"
                  )

          Path(os.environ.get("GITHUB_STEP_SUMMARY", "branch_audit_summary.md")).write_text("\n".join(summary_lines), encoding="utf-8")
          PY
