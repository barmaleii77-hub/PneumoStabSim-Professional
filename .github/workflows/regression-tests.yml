name: Physics and UI Regression

on:
  push:
    branches:
      - develop
      - main
      - 'feature/*'
      - feature/hdr-assets-migration
    paths:
      - "src/**"
      - "tests/**"
      - "tools/**"
      - "config/schemas/**"
      - ".github/workflows/regression-tests.yml"
  pull_request:
    branches:
      - develop
      - main
      - 'feature/*'
      - feature/hdr-assets-migration
    paths:
      - "src/**"
      - "tests/**"
      - "tools/**"
      - "config/schemas/**"

jobs:
  regression:
    runs-on: ubuntu-latest
    env:
      QT_QPA_PLATFORM: offscreen
      QT_QUICK_BACKEND: software
      QSG_RHI_BACKEND: opengl
      LIBGL_ALWAYS_SOFTWARE: "1"
      MESA_GL_VERSION_OVERRIDE: "4.1"
      MESA_GLSL_VERSION_OVERRIDE: "410"
      PSS_ENV_PRESET: trace
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Set up uv
        uses: astral-sh/setup-uv@8d55fbecc275b1c35dbe060458839f8d30439ccf

      - name: Sync environment
        run: uv sync --frozen --extra dev

      - name: Ensure PySide6 runtime packages
        run: |
          uv run python -m pip install --upgrade --no-cache-dir \
            "PySide6>=6.10,<7" \
            "PySide6-Addons>=6.10,<7" \
            "PySide6-Essentials>=6.10,<7" \
            "shiboken6>=6.10,<7" \
            "PyOpenGL==3.1.10" \
            "PyOpenGL-accelerate==3.1.10"

      - name: Install headless Qt Quick dependencies
        run: |
          sudo add-apt-repository -y universe
          sudo apt-get update

          # Packages are installed conditionally; unavailable entries are skipped.
          pkgs=(
            xvfb xauth mesa-utils mesa-utils-extra libosmesa6
            libgl1 libgl1-mesa-dri libglu1-mesa libglu1-mesa-dev
            libegl1 libegl1-mesa-dev libgles2-mesa-dev
            libxcb-xinerama0 libxkbcommon0 libxkbcommon-x11-0 libvulkan1
            libosmesa6-dev libgbm1 libdrm2
            libxcb-keysyms1 libxcb-image0 libxcb-icccm4 libxcb-render-util0 libxcb-xfixes0 libxcb-shape0 libxcb-randr0 libxcb-glx0
            mesa-vulkan-drivers vulkan-tools
            qt6-shader-baker
          )

          to_install=()
          for pkg in "${pkgs[@]}"; do
            if apt-cache show "$pkg" >/dev/null 2>&1; then
              to_install+=("$pkg")
            else
              echo "Skipping unavailable package: $pkg"
            fi
          done

          if [ "${#to_install[@]}" -gt 0 ]; then
            sudo apt-get install -y --no-install-recommends "${to_install[@]}"
          else
            echo "No packages available for installation"
          fi

      - name: Run final readiness test
        run: bash scripts/xvfb_wrapper.sh uv run python final_readiness_test.py

      - name: Run pytest suite
        run: bash scripts/xvfb_wrapper.sh uv run pytest --maxfail=1

      - name: Execute physics regression case
        run: uv run python tools/run_test_case.py standard-suspension-balance --output-dir reports/tests

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: regression-reports
          path: reports/tests

      - name: Post summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const summary = `âœ… Physics/UI regression executed. Artifacts: regression-reports.`;
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
