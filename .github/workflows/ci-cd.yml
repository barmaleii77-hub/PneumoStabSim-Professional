name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - develop
      - 'feature/*'
      - 'feature/hdr-assets-migration' # ensure HDR assets migration branch runs CI/CD
  pull_request:
    branches:
      - master
      - develop
      - 'feature/*'
      - 'feature/hdr-assets-migration' # ensure HDR assets migration branch runs CI/CD

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-22.04]
        python-version: ['3.12', '3.13']
    env:
      QT_QPA_PLATFORM: offscreen
      QT_QUICK_BACKEND: rhi
      QSG_RHI_BACKEND: d3d11
      LIBGL_ALWAYS_SOFTWARE: "1"
      MESA_GL_VERSION_OVERRIDE: "4.1"
      MESA_GLSL_VERSION_OVERRIDE: "410"
      PSS_ENV_PRESET: trace
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Install headless Qt Quick dependencies (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          packages=(
            xvfb xauth mesa-utils mesa-utils-extra libosmesa6
            libgl1 libgl1-mesa-dri libglu1-mesa libglu1-mesa-dev
            libegl1 libegl1-mesa-dev libgles2-mesa-dev
            libxcb-xinerama0 libxkbcommon0 libxkbcommon-x11-0 libxkbcommon-dev libvulkan1
            libosmesa6-dev libgbm1 libdrm2
            libxcb-keysyms1 libxcb-image0 libxcb-icccm4 libxcb-render-util0 libxcb-xfixes0 libxcb-shape0 libxcb-randr0 libxcb-glx0
            mesa-vulkan-drivers vulkan-tools qt6-shader-baker qt6-shadertools-dev
          )

          to_install=()
          for pkg in "${packages[@]}"; do
            if dpkg -s "$pkg" >/dev/null 2>&1; then
              echo "Package $pkg already installed"
              continue
            fi
            if apt-cache show "$pkg" >/dev/null 2>&1; then
              to_install+=("$pkg")
            else
              echo "Skipping unavailable package: $pkg"
            fi
          done

          if [ "${#to_install[@]}" -gt 0 ]; then
            sudo apt-get install -y --no-install-recommends "${to_install[@]}"
          else
            echo "No additional apt packages required"
          fi

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install project and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]
          pip install \
            "PySide6==6.10.*" \
            "PySide6-Addons==6.10.*" \
            "PySide6-Essentials==6.10.*" \
            "shiboken6==6.10.*" \
            numpy \
            pytest-qt

      - name: Check dependency graph with uv
        shell: bash
        run: |
          set -o pipefail
          mkdir -p reports/dependencies
          uv pip check | tee reports/dependencies/uv-pip-check.log
          {
            echo "### uv pip check";
            echo '```';
            cat reports/dependencies/uv-pip-check.log;
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Configure Qt runtime paths
        shell: python
        run: |
          import os
          from pathlib import Path

          def write_env(key: str, value: str) -> None:
              if not value:
                  return
              env_file = Path(os.environ["GITHUB_ENV"])
              with env_file.open("a", encoding="utf-8") as handle:
                  handle.write(f"{key}={value}\n")

          try:
              from PySide6.QtCore import QLibraryInfo, LibraryLocation
          except Exception as exc:  # pragma: no cover - diagnostic output only
              print(f"Unable to configure Qt paths automatically: {exc}")
          else:
              write_env("QT_PLUGIN_PATH", QLibraryInfo.path(LibraryLocation.Plugins))
              write_env("QML2_IMPORT_PATH", QLibraryInfo.path(LibraryLocation.QmlImports))

      - name: Run Windows dependency bootstrap
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
          ./scripts/setup_windows.ps1 -SkipUvSync -SummaryPath $env:GITHUB_STEP_SUMMARY

      - name: Verify Qt environment
        shell: bash
        env:
          QT_QPA_PLATFORM: offscreen
          QT_QUICK_BACKEND: rhi
          QSG_RHI_BACKEND: d3d11
          PSS_ENV_PRESET: trace
        run: |
          python tools/environment/verify_qt_setup.py --report-dir reports/environment

      - name: Ensure GNU Make (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: choco install make --yes

      - name: Provision Windows Qt runtime
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: ./scripts/setup_windows.ps1 -Python "${{ env.pythonLocation }}\\python.exe" -SummaryPath $env:GITHUB_STEP_SUMMARY

      - name: Configure pytest command
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
            echo "PYTEST_PREFIX=xvfb-run -a" >> "$GITHUB_ENV"
          else
            echo "PYTEST_PREFIX=" >> "$GITHUB_ENV"
          fi

      - name: Prepare pytest reports directory
        run: mkdir -p reports/tests

      - name: Run smoke/integration verification
        shell: bash
        run: |
          if [ -n "${PYTEST_PREFIX:-}" ]; then
            make verify PYTEST="${PYTEST_PREFIX} pytest"
          else
            make verify
          fi

      - name: Run unit tests
        shell: bash
        run: |
          if [ -n "${PYTEST_PREFIX:-}" ]; then
            ${PYTEST_PREFIX} pytest tests/unit/ -v --cov=src --cov-report=xml \
              --junitxml=reports/tests/ci-cd-unit.xml
          else
            pytest tests/unit/ -v --cov=src --cov-report=xml \
              --junitxml=reports/tests/ci-cd-unit.xml
          fi

      - name: Run integration tests
        shell: bash
        run: |
          if [ -n "${PYTEST_PREFIX:-}" ]; then
            ${PYTEST_PREFIX} pytest tests/integration/ -v --cov=src --cov-report=xml --cov-append \
              --junitxml=reports/tests/ci-cd-integration.xml
          else
            pytest tests/integration/ -v --cov=src --cov-report=xml --cov-append \
              --junitxml=reports/tests/ci-cd-integration.xml
          fi

      - name: Run system tests
        shell: bash
        run: |
          if [ -n "${PYTEST_PREFIX:-}" ]; then
            ${PYTEST_PREFIX} pytest tests/system/ -v --cov=src --cov-report=xml --cov-append \
              --junitxml=reports/tests/ci-cd-system.xml
          else
            pytest tests/system/ -v --cov=src --cov-report=xml --cov-append \
              --junitxml=reports/tests/ci-cd-system.xml
          fi

      - name: Enforce skip policy for matrix pytest runs
        if: always()
        run: |
          python -m tools.quality.skip_policy --ci \
            --junitxml reports/tests/ci-cd-unit.xml \
            --junitxml reports/tests/ci-cd-integration.xml \
            --junitxml reports/tests/ci-cd-system.xml \
            --summary reports/tests/ci-cd-skipped.md

      - name: Upload smoke/integration logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: qt-logs-${{ matrix.os }}-${{ matrix.python-version }}
          path: logs
          if-no-files-found: warn

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238
        with:
          file: ./coverage.xml
          flags: unit,integration,system
          name: codecov-${{ matrix.os }}-${{ matrix.python-version }}

  verify:
    name: Code Quality
    runs-on: ubuntu-latest
    env:
      QT_QPA_PLATFORM: offscreen
      QT_QUICK_BACKEND: rhi
      QSG_RHI_BACKEND: d3d11
      QT_PLUGIN_PATH: ''
      QML2_IMPORT_PATH: ''
      PSS_ENV_PRESET: trace

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Install headless Qt Quick dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb xauth dbus-x11 \
            mesa-utils mesa-utils-extra libosmesa6 \
            libgl1 libgl1-mesa-dri libgl1-mesa-glx libglu1-mesa \
            libegl1 libegl1-mesa libgles2 libgles2-mesa \
            libxcb-xinerama0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
            libxcb-render-util0 libxcb-shape0 libxcb-randr0 libxcb-glx0 libxcb-xfixes0 \
            libxkbcommon0 libxkbcommon-x11-0 libxkbcommon-dev \
            libvulkan1 mesa-vulkan-drivers vulkan-tools \
            qt6-shader-baker qt6-shadertools-dev

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.13'

      - name: Install development dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]
          pip install \
            "PySide6==6.10.*" \
            "PySide6-Addons==6.10.*" \
            "PySide6-Essentials==6.10.*" \
            "shiboken6==6.10.*" \
            numpy \
            pytest-qt

      - name: Check dependency graph with uv
        shell: bash
        run: |
          set -o pipefail
          mkdir -p reports/dependencies
          uv pip check | tee reports/dependencies/uv-pip-check.log
          {
            echo "### uv pip check";
            echo '```';
            cat reports/dependencies/uv-pip-check.log;
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Configure Qt runtime paths
        shell: python
        run: |
          import os
          from pathlib import Path

          def write_env(key: str, value: str) -> None:
              if not value:
                  return
              env_file = Path(os.environ["GITHUB_ENV"])
              with env_file.open("a", encoding="utf-8") as handle:
                  handle.write(f"{key}={value}\n")

          try:
              from PySide6.QtCore import QLibraryInfo, LibraryLocation
          except Exception as exc:  # pragma: no cover - diagnostic output only
              print(f"Unable to configure Qt paths automatically: {exc}")
          else:
              write_env("QT_PLUGIN_PATH", QLibraryInfo.path(LibraryLocation.Plugins))
              write_env("QML2_IMPORT_PATH", QLibraryInfo.path(LibraryLocation.QmlImports))

      - name: Verify Qt environment
        shell: bash
        env:
          QT_QPA_PLATFORM: ${{ env.QT_QPA_PLATFORM }}
          QT_QUICK_BACKEND: ${{ env.QT_QUICK_BACKEND }}
          QSG_RHI_BACKEND: ${{ env.QSG_RHI_BACKEND }}
          PSS_ENV_PRESET: ${{ env.PSS_ENV_PRESET }}
        run: |
          python tools/environment/verify_qt_setup.py --report-dir reports/environment

      - name: Run make verify
        run: make verify

  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: [test, verify]

    steps:
    - name: Checkout code
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: '3.13'

    - name: Install project with documentation extras
      run: |
        python -m pip install --upgrade pip
        pip install .[docs]

    - name: Check dependency graph with uv
      shell: bash
      run: |
        set -o pipefail
        mkdir -p reports/dependencies
        uv pip check | tee reports/dependencies/uv-pip-check.log
        {
          echo "### uv pip check";
          echo '```';
          cat reports/dependencies/uv-pip-check.log;
          echo '```';
        } >> "$GITHUB_STEP_SUMMARY"

    - name: Build documentation
      run: |
        sphinx-build -b html docs docs/_build/html

    - name: Upload documentation artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: documentation-html
        path: docs/_build/html
