name: CI/CD Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-22.04]
        python-version: ['3.12', '3.13']
    env:
      QT_QPA_PLATFORM: offscreen
      QT_QUICK_BACKEND: software
      LIBGL_ALWAYS_SOFTWARE: "1"
      MESA_GL_VERSION_OVERRIDE: "4.1"
      MESA_GLSL_VERSION_OVERRIDE: "410"
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Install headless Qt Quick dependencies (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb xauth mesa-utils mesa-utils-extra libosmesa6 \
            libgl1-mesa-dri libgl1-mesa-glx libglu1-mesa libegl1-mesa libgles2-mesa \
            libxcb-xinerama0 libxkbcommon0 libxkbcommon-x11-0 libvulkan1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install project and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]
          pip install "PySide6>=6.10,<7" "PySide6-Addons>=6.10,<7" "PySide6-Essentials>=6.10,<7"

      - name: Configure Qt runtime paths
        shell: python
        run: |
          import os
          from pathlib import Path

          def write_env(key: str, value: str) -> None:
              if not value:
                  return
              env_file = Path(os.environ["GITHUB_ENV"])
              with env_file.open("a", encoding="utf-8") as handle:
                  handle.write(f"{key}={value}\n")

          try:
              from PySide6.QtCore import QLibraryInfo, LibraryLocation
          except Exception as exc:  # pragma: no cover - diagnostic output only
              print(f"Unable to configure Qt paths automatically: {exc}")
          else:
              write_env("QT_PLUGIN_PATH", QLibraryInfo.path(LibraryLocation.Plugins))
              write_env("QML2_IMPORT_PATH", QLibraryInfo.path(LibraryLocation.QmlImports))

      - name: Verify Qt environment
        shell: bash
        env:
          QT_QPA_PLATFORM: offscreen
          QT_QUICK_BACKEND: software
        run: |
          python tools/environment/verify_qt_setup.py --report-dir reports/environment

      - name: Ensure GNU Make (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: choco install make --yes

      - name: Configure pytest command
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
            echo "PYTEST_PREFIX=xvfb-run -a" >> "$GITHUB_ENV"
          else
            echo "PYTEST_PREFIX=" >> "$GITHUB_ENV"
          fi

      - name: Run smoke/integration verification
        shell: bash
        run: |
          if [ -n "${PYTEST_PREFIX:-}" ]; then
            make verify PYTEST="${PYTEST_PREFIX} pytest"
          else
            make verify
          fi

      - name: Run unit tests
        shell: bash
        run: |
          if [ -n "${PYTEST_PREFIX:-}" ]; then
            ${PYTEST_PREFIX} pytest tests/unit/ -v --cov=src --cov-report=xml
          else
            pytest tests/unit/ -v --cov=src --cov-report=xml
          fi

      - name: Run integration tests
        shell: bash
        run: |
          if [ -n "${PYTEST_PREFIX:-}" ]; then
            ${PYTEST_PREFIX} pytest tests/integration/ -v --cov=src --cov-report=xml --cov-append
          else
            pytest tests/integration/ -v --cov=src --cov-report=xml --cov-append
          fi

      - name: Run system tests
        shell: bash
        run: |
          if [ -n "${PYTEST_PREFIX:-}" ]; then
            ${PYTEST_PREFIX} pytest tests/system/ -v --cov=src --cov-report=xml --cov-append
          else
            pytest tests/system/ -v --cov=src --cov-report=xml --cov-append
          fi

      - name: Upload smoke/integration logs
        if: always()
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: qt-logs-${{ matrix.os }}-${{ matrix.python-version }}
          path: logs
          if-no-files-found: warn

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unit,integration,system
          name: codecov-${{ matrix.os }}-${{ matrix.python-version }}

  verify:
    name: Code Quality
    runs-on: ubuntu-latest
    env:
      QT_QPA_PLATFORM: offscreen
      QT_QUICK_BACKEND: software
      QT_PLUGIN_PATH: ''
      QML2_IMPORT_PATH: ''

    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Install headless Qt Quick dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb xauth mesa-utils mesa-utils-extra libosmesa6 \
            libgl1-mesa-dri libgl1-mesa-glx libglu1-mesa libegl1-mesa libgles2-mesa \
            libxcb-xinerama0 libxkbcommon0 libxkbcommon-x11-0 libvulkan1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install development dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]

      - name: Configure Qt runtime paths
        shell: python
        run: |
          import os
          from pathlib import Path

          def write_env(key: str, value: str) -> None:
              if not value:
                  return
              env_file = Path(os.environ["GITHUB_ENV"])
              with env_file.open("a", encoding="utf-8") as handle:
                  handle.write(f"{key}={value}\n")

          try:
              from PySide6.QtCore import QLibraryInfo, LibraryLocation
          except Exception as exc:  # pragma: no cover - diagnostic output only
              print(f"Unable to configure Qt paths automatically: {exc}")
          else:
              write_env("QT_PLUGIN_PATH", QLibraryInfo.path(LibraryLocation.Plugins))
              write_env("QML2_IMPORT_PATH", QLibraryInfo.path(LibraryLocation.QmlImports))

      - name: Verify Qt environment
        shell: bash
        env:
          QT_QPA_PLATFORM: ${{ env.QT_QPA_PLATFORM }}
          QT_QUICK_BACKEND: ${{ env.QT_QUICK_BACKEND }}
        run: |
          python tools/environment/verify_qt_setup.py --report-dir reports/environment

      - name: Run make verify
        run: make verify

  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: [test, verify]

    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install project with documentation extras
      run: |
        python -m pip install --upgrade pip
        pip install .[docs]

    - name: Build documentation
      run: |
        sphinx-build -b html docs docs/_build/html

    - name: Upload documentation artifact
      uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
      with:
        name: documentation-html
        path: docs/_build/html
