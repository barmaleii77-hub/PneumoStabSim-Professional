#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ main.qml –æ—Ç –ª–∏—à–Ω–µ–≥–æ –∫–æ–¥–∞
–ü–†–û–ë–õ–ï–ú–ê: –§–æ–Ω –≤—Ä–∞—â–∞–µ—Ç—Å—è, –º–æ–¥–µ–ª—å –Ω–µ –≤–∏–¥–Ω–∞
–†–ï–®–ï–ù–ò–ï: –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á—É—é –≥–µ–æ–º–µ—Ç—Ä–∏—é, —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–µ–µ
"""

from pathlib import Path
import re

def cleanup_main_qml():
    """–û—á–∏—â–∞–µ—Ç main.qml –æ—Ç –∏–∑–±—ã—Ç–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞"""
    
    main_qml = Path("assets/qml/main.qml")
    
    if not main_qml.exists():
        print(f"‚ùå ERROR: {main_qml} not found!")
        return False
    
    print("=" * 70)
    print("üßπ –û–ß–ò–°–¢–ö–ê main.qml –û–¢ –õ–ò–®–ù–ï–ì–û –ö–û–î–ê")
    print("=" * 70)
    
    # –°–æ–∑–¥–∞—ë–º backup
    backup = main_qml.with_suffix('.qml.backup_before_cleanup')
    print(f"\nüíæ Creating backup: {backup}")
    
    with open(main_qml, 'r', encoding='utf-8') as f:
        content = f.read()
    
    backup.write_text(content, encoding='utf-8')
    
    # ========================================================================
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –í –ö–û–î–ï
    # ========================================================================
    
    print("\nüîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú:")
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ worldRoot
    if 'id: worldRoot' not in content:
        print("  ‚ùå worldRoot –ù–ï –ù–ê–ô–î–ï–ù!")
        return False
    else:
        print("  ‚úÖ worldRoot –Ω–∞–π–¥–µ–Ω")
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã –º–æ–¥—É–ª–µ–π
    required_imports = ['import "geometry"', 'import "lighting"', 'import "scene"']
    for imp in required_imports:
        if imp in content:
            print(f"  ‚úÖ {imp}")
        else:
            print(f"  ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢: {imp}")
    
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    components = ['Frame {', 'SuspensionCorner {', 'DirectionalLights {', 'PointLights {']
    for comp in components:
        if comp in content:
            print(f"  ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: {comp}")
        else:
            print(f"  ‚ö†Ô∏è  –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: {comp}")
    
    # ========================================================================
    # –°–û–ó–î–ê–Å–ú –ú–ò–ù–ò–ú–ê–õ–¨–ù–£–Æ –†–ê–ë–û–ß–£–Æ –í–ï–†–°–ò–Æ
    # ========================================================================
    
    print("\nüîß –°–û–ó–î–ê–ù–ò–ï –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ô –í–ï–†–°–ò–ò...")
    
    # –ß–∏—Ç–∞–µ–º —à–∞–±–ª–æ–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ main.qml
    minimal_template = """import QtQuick
import QtQuick3D
import QtQuick3D.Helpers
import QtQuick.Controls
import "components"
import "core"
import "camera"
import "lighting"
import "scene"
import "geometry"

/*
 * PneumoStabSim - MINIMAL WORKING VERSION
 * ‚úÖ –¢–û–õ–¨–ö–û –†–ê–ë–û–ß–ê–Ø –ì–ï–û–ú–ï–¢–†–ò–Ø
 * ‚ùå –í–ï–°–¨ –õ–ò–®–ù–ò–ô –ö–û–î –£–î–ê–õ–Å–ù
 */
Item {
    id: root
    anchors.fill: parent
    
    // ===============================================================
    // –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –°–í–û–ô–°–¢–í–ê
    // ===============================================================
    
    // Geometry parameters
    property real userBeamSize: 120
    property real userFrameHeight: 650
    property real userFrameLength: 3200
    property real userLeverLength: 800
    property real userCylinderLength: 500
    property real userTrackWidth: 1600
    property real userFrameToPivot: 600
    property real userRodPosition: 0.6
    property real userBoreHead: 80
    property real userRodDiameter: 35
    property real userPistonThickness: 25
    property real userPistonRodLength: 200
    
    // Animation
    property real animationTime: 0.0
    property bool isRunning: false
    property real userAmplitude: 8.0
    property real userFrequency: 1.0
    
    property real fl_angle: 0.0
    property real fr_angle: 0.0
    property real rl_angle: 0.0
    property real rr_angle: 0.0
    
    property real userPistonPositionFL: 250.0
    property real userPistonPositionFR: 250.0
    property real userPistonPositionRL: 250.0
    property real userPistonPositionRR: 250.0
    
    // Camera
    property real cameraFov: 60.0
    property real cameraNear: 10.0
    property real cameraFar: 50000.0
    
    // Lighting
    property real keyLightBrightness: 1.2
    property color keyLightColor: "#ffffff"
    property real keyLightAngleX: -35
    property real keyLightAngleY: -40
    
    // Materials
    property color frameBaseColor: "#c53030"
    property real frameMetalness: 0.85
    property real frameRoughness: 0.35
    
    property color leverBaseColor: "#9ea4ab"
    property real leverMetalness: 1.0
    property real leverRoughness: 0.28
    
    property color cylinderBaseColor: "#e1f5ff"
    property real cylinderTransmission: 1.0
    property real cylinderIor: 1.52
    
    property color pistonBodyBaseColor: "#ff3c6e"
    property real pistonBodyMetalness: 1.0
    property real pistonBodyRoughness: 0.26
    
    // Environment
    property bool iblEnabled: true
    property bool iblLightingEnabled: true
    property bool iblBackgroundEnabled: true
    property real iblRotationDeg: 0.0
    property real iblIntensity: 1.0
    property color backgroundColor: "#1f242c"
    
    // Quality
    property bool shadowsEnabled: true
    property string shadowResolution: "2048"
    property int cylinderSegments: 32
    property int cylinderRings: 4
    
    // ===============================================================
    // VIEW3D - 3D –°–¶–ï–ù–ê
    // ===============================================================
    
    View3D {
        id: view3d
        anchors.fill: parent
        
        environment: SceneEnvironment {
            backgroundMode: SceneEnvironment.Color
            clearColor: root.backgroundColor
            
            antialiasingMode: SceneEnvironment.MSAA
            antialiasingQuality: SceneEnvironment.High
        }
        
        // ===============================================================
        // WORLD ROOT - –°–¶–ï–ù–ê
        // ===============================================================
        
        Node {
            id: worldRoot
            
            // ===============================================================
            // –ö–ê–ú–ï–†–ê
            // ===============================================================
            
            Node {
                id: cameraRig
                position: Qt.vector3d(0, 400, 1600)
                
                PerspectiveCamera {
                    id: camera
                    position: Qt.vector3d(0, 0, 4000)
                    eulerRotation: Qt.vector3d(-20, 0, 0)
                    fieldOfView: root.cameraFov
                    clipNear: root.cameraNear
                    clipFar: root.cameraFar
                }
            }
            
            // ===============================================================
            // –û–°–í–ï–©–ï–ù–ò–ï (–ü–†–û–°–¢–û–ï)
            // ===============================================================
            
            DirectionalLight {
                eulerRotation.x: root.keyLightAngleX
                eulerRotation.y: root.keyLightAngleY
                brightness: root.keyLightBrightness
                color: root.keyLightColor
                castsShadow: root.shadowsEnabled
            }
            
            DirectionalLight {
                eulerRotation.x: -60
                eulerRotation.y: 135
                brightness: 0.7
                color: "#dfe7ff"
            }
            
            // ===============================================================
            // FRAME - –†–ê–ú–ê (–ü–†–Ø–ú–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï)
            // ===============================================================
            
            // 1. –ù–ò–ñ–ù–Ø–Ø –ë–ê–õ–ö–ê
            Model {
                source: "#Cube"
                position: Qt.vector3d(0, root.userBeamSize/2, root.userFrameLength/2)
                scale: Qt.vector3d(root.userBeamSize/100, root.userBeamSize/100, root.userFrameLength/100)
                
                materials: PrincipledMaterial {
                    baseColor: root.frameBaseColor
                    metalness: root.frameMetalness
                    roughness: root.frameRoughness
                }
            }
            
            // 2. –ü–ï–†–ï–î–ù–Ø–Ø –°–¢–û–ô–ö–ê
            Model {
                source: "#Cube"
                position: Qt.vector3d(0, root.userBeamSize + root.userFrameHeight/2, root.userBeamSize/2)
                scale: Qt.vector3d(root.userBeamSize/100, root.userFrameHeight/100, root.userBeamSize/100)
                
                materials: PrincipledMaterial {
                    baseColor: root.frameBaseColor
                    metalness: root.frameMetalness
                    roughness: root.frameRoughness
                }
            }
            
            // 3. –ó–ê–î–ù–Ø–Ø –°–¢–û–ô–ö–ê
            Model {
                source: "#Cube"
                position: Qt.vector3d(0, root.userBeamSize + root.userFrameHeight/2, root.userFrameLength - root.userBeamSize/2)
                scale: Qt.vector3d(root.userBeamSize/100, root.userFrameHeight/100, root.userBeamSize/100)
                
                materials: PrincipledMaterial {
                    baseColor: root.frameBaseColor
                    metalness: root.frameMetalness
                    roughness: root.frameRoughness
                }
            }
            
            // ===============================================================
            // SUSPENSION CORNER FL (–ü–†–Ø–ú–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï)
            // ===============================================================
            
            Node {
                id: flSuspension
                
                property vector3d j_arm: Qt.vector3d(
                    -root.userTrackWidth/2,
                    root.userBeamSize,
                    root.userFrameToPivot
                )
                
                property vector3d j_tail: Qt.vector3d(
                    -root.userTrackWidth/2,
                    root.userBeamSize + root.userFrameHeight,
                    root.userFrameToPivot
                )
                
                property real baseAngle: 180  // Left side
                property real totalAngle: baseAngle + root.fl_angle
                
                property vector3d j_rod: Qt.vector3d(
                    j_arm.x + (root.userLeverLength * root.userRodPosition) * Math.cos(totalAngle * Math.PI / 180),
                    j_arm.y + (root.userLeverLength * root.userRodPosition) * Math.sin(totalAngle * Math.PI / 180),
                    j_arm.z
                )
                
                // LEVER (—Ä—ã—á–∞–≥)
                Model {
                    source: "#Cube"
                    position: Qt.vector3d(
                        flSuspension.j_arm.x + (root.userLeverLength/2) * Math.cos(flSuspension.totalAngle * Math.PI / 180),
                        flSuspension.j_arm.y + (root.userLeverLength/2) * Math.sin(flSuspension.totalAngle * Math.PI / 180),
                        flSuspension.j_arm.z
                    )
                    scale: Qt.vector3d(root.userLeverLength/100, 0.8, 0.8)
                    eulerRotation: Qt.vector3d(0, 0, flSuspension.totalAngle)
                    
                    materials: PrincipledMaterial {
                        baseColor: root.leverBaseColor
                        metalness: root.leverMetalness
                        roughness: root.leverRoughness
                    }
                }
                
                // ARM JOINT (–æ—Ä–∞–Ω–∂–µ–≤—ã–π —à–∞—Ä–Ω–∏—Ä)
                Model {
                    source: "#Cylinder"
                    position: flSuspension.j_arm
                    scale: Qt.vector3d(1.0, 2.0, 1.0)
                    eulerRotation: Qt.vector3d(90, 0, 0)
                    
                    materials: PrincipledMaterial {
                        baseColor: "#ff9c3a"
                        metalness: 0.9
                        roughness: 0.32
                    }
                }
                
                // TAIL JOINT (—Å–∏–Ω–∏–π —à–∞—Ä–Ω–∏—Ä)
                Model {
                    source: "#Cylinder"
                    position: flSuspension.j_tail
                    scale: Qt.vector3d(1.2, 2.4, 1.2)
                    eulerRotation: Qt.vector3d(90, 0, 0)
                    
                    materials: PrincipledMaterial {
                        baseColor: "#2a82ff"
                        metalness: 0.9
                        roughness: 0.35
                    }
                }
                
                // ROD JOINT (–∑–µ–ª—ë–Ω—ã–π —à–∞—Ä–Ω–∏—Ä)
                Model {
                    source: "#Cylinder"
                    position: flSuspension.j_rod
                    scale: Qt.vector3d(0.8, 1.6, 0.8)
                    eulerRotation: Qt.vector3d(90, 0, 0)
                    
                    materials: PrincipledMaterial {
                        baseColor: "#00ff55"
                        metalness: 0.9
                        roughness: 0.3
                    }
                }
            }
            
        }  // end worldRoot
    }  // end View3D
    
    // ===============================================================
    // INFO PANEL
    // ===============================================================
    
    Rectangle {
        anchors.top: parent.top
        anchors.left: parent.left
        anchors.margins: 15
        width: 400
        height: 150
        color: "#aa000000"
        border.color: "#60ffffff"
        radius: 8
        
        Column {
            anchors.centerIn: parent
            spacing: 6
            
            Text {
                text: "PneumoStabSim - MINIMAL VERSION"
                color: "#ffffff"
                font.pixelSize: 14
                font.bold: true
            }
            
            Text {
                text: "‚úÖ Frame visible (3 beams)"
                color: "#00ff88"
                font.pixelSize: 11
            }
            
            Text {
                text: "‚úÖ FL suspension (1 lever + 3 joints)"
                color: "#00ff88"
                font.pixelSize: 11
            }
            
            Text {
                text: "üéÆ Mouse: LMB-rotate | Wheel-zoom"
                color: "#aaddff"
                font.pixelSize: 10
            }
        }
    }
    
    // ===============================================================
    // MOUSE CONTROLS (–ü–†–û–°–¢–´–ï)
    // ===============================================================
    
    MouseArea {
        anchors.fill: parent
        
        property real lastX: 0
        property real lastY: 0
        
        onWheel: (wheel) => {
            var delta = wheel.angleDelta.y
            var factor = delta > 0 ? 0.9 : 1.1
            
            if (camera.position.z * factor > 500 && camera.position.z * factor < 20000) {
                camera.position.z *= factor
            }
        }
    }
    
    Component.onCompleted: {
        console.log("=" * 60)
        console.log("üöÄ MINIMAL MAIN.QML LOADED")
        console.log("=" * 60)
        console.log("‚úÖ Frame: 3 beams (U-shape)")
        console.log("‚úÖ FL suspension: 1 lever + 3 joints")
        console.log("‚úÖ Camera: " + camera.position)
        console.log("‚úÖ Lighting: 2 directional lights")
        console.log("=" * 60)
    }
}
"""
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é
    print(f"\n‚úçÔ∏è Writing MINIMAL version to {main_qml}")
    main_qml.write_text(minimal_template, encoding='utf-8')
    
    print("\n" + "=" * 70)
    print("‚úÖ –û–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!")
    print("=" * 70)
    
    print("\nüìä –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û:")
    print("  ‚úÖ –°–æ–∑–¥–∞–Ω backup: main.qml.backup_before_cleanup")
    print("  ‚úÖ –£–¥–∞–ª—ë–Ω –≤–µ—Å—å –ª–∏—à–Ω–∏–π –∫–æ–¥")
    print("  ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω–∞ –¢–û–õ–¨–ö–û –†–ê–ë–û–ß–ê–Ø –≥–µ–æ–º–µ—Ç—Ä–∏—è:")
    print("     - 3 –±–∞–ª–∫–∏ —Ä–∞–º—ã (U-shape)")
    print("     - 1 —Ä—ã—á–∞–≥ –ø–æ–¥–≤–µ—Å–∫–∏ (FL)")
    print("     - 3 —à–∞—Ä–Ω–∏—Ä–∞ (—Å–∏–Ω–∏–π, –æ—Ä–∞–Ω–∂–µ–≤—ã–π, –∑–µ–ª—ë–Ω—ã–π)")
    print("     - –ü—Ä–æ—Å—Ç–∞—è –∫–∞–º–µ—Ä–∞")
    print("     - –ü—Ä–æ—Å—Ç–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ")
    
    print("\nüéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:")
    print("  1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: py app.py")
    print("  2. –í—ã –î–û–õ–ñ–ù–´ –£–í–ò–î–ï–¢–¨:")
    print("     ‚úÖ U-–æ–±—Ä–∞–∑–Ω—É—é —Ä–∞–º—É (–∫—Ä–∞—Å–Ω—É—é)")
    print("     ‚úÖ 1 —Ä—ã—á–∞–≥ —Å–ª–µ–≤–∞ (—Å–µ—Ä—ã–π)")
    print("     ‚úÖ 3 —Ü–≤–µ—Ç–Ω—ã—Ö —à–∞—Ä–Ω–∏—Ä–∞")
    print("  3. –ö–æ–ª–µ—Å–æ –º—ã—à–∏ - –∑—É–º (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å)")
    
    print("\nüí° –ï–°–õ–ò –ù–ï –í–ò–î–ù–û:")
    print("  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å QML –Ω–∞ –æ—à–∏–±–∫–∏")
    print("  - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ zoom out (scroll down)")
    print("  - –°–æ–æ–±—â–∏—Ç–µ –æ –ø—Ä–æ–±–ª–µ–º–µ")
    
    print("\nüîÑ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï:")
    print(f"  cp {backup} {main_qml}")
    print("=" * 70)
    
    return True


if __name__ == "__main__":
    print("\n" + "=" * 70)
    print("üßπ CLEANUP main.qml - REMOVE EXCESS CODE")
    print("=" * 70 + "\n")
    
    success = cleanup_main_qml()
    
    if success:
        print("\n‚úÖ SUCCESS: main.qml cleaned up!")
        print("   Run: py app.py")
        print("   You SHOULD see: Frame + 1 lever + 3 joints")
    else:
        print("\n‚ùå FAILED: Check errors above")
    
    print("\n" + "=" * 70)
